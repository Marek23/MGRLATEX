\documentclass[12pt, twoside, openany]{report}
\usepackage[dvips]{graphicx,color,rotating}
\usepackage[utf8]{inputenc}
\usepackage{t1enc}
\usepackage{a4wide}
\usepackage{amsfonts}
\usepackage{mathtools}
\usepackage{amsmath}
\usepackage{enumerate}
\usepackage{hyperref}
\usepackage{verbatim}
\usepackage{longtable}
\usepackage[MeX]{polski}
\usepackage[T1]{fontenc}
\usepackage{geometry}
\usepackage{listings}
\geometry{left=25mm,right=25mm,%
bindingoffset=10mm, top=25mm, bottom=25mm}
\usepackage{amssymb, latexsym}
\usepackage{amsthm}
\usepackage{palatino}
\usepackage{array}
\usepackage{pstricks}
\usepackage{comment}
\usepackage{textcomp}
\theoremstyle{definition}
\newtheorem{theorem}{Twierdzenie}[section]
\newtheorem{remark}{Uwaga}[section]
\newtheorem{definition}{Definicja}[section]
\newtheorem{alg}{Algorytm}[chapter]
\newtheorem{prz}{Przypadek}[section]
\newtheorem{np}{Przykład}[section]
\newtheorem{lemma}[theorem]{Lemat}
\linespread{1.5}
\newcommand*{\norm}[1]{\left\Vert{#1}\right\Vert}
\newcommand*{\abs}[1]{\left\vert{#1}\right\vert}
\newcommand*{\om}{\omega}

\renewcommand*{\figureautorefname}{Rysunek}
\renewcommand*{\tableautorefname}{Tabela}
\renewcommand*{\chapterautorefname}{Rozdział}
\renewcommand*{\sectionautorefname}{Rozdział}


\author{Marek Szweda}
\title{Poprawa jakości obrazów cyfrowych poprzez metodę wmalowywania}

\begin{document}

\def \kotmyszm{Obraz 1}
\def \maciekIm{Obraz 2}
\def \ObrIm{Obraz 3}
\def \ObrIVm{Obraz 4}
\def \ObrVm{Obraz 5}
\def \ObrVIm{Obraz 6}
\def \ObrXVm{Obraz 7}
\def \ObrXVIIm{Obraz 8}
\def \ObrXIXm{Obraz 9}
\def \ObrXXVIIIkm{Obraz 10}
\def \OsobaDrugam{Obraz 11}
\def \ObrXIIIm{Obraz 12}
\def \XXVIII{Obraz 1}
\def \TEST{Obraz 2}
\def \Wood{Obraz 3}

\begin{titlepage}
\pagestyle{empty}

\noindent
\begin{Large}
\begin{table}[t]
\centering
\begin{tabular}[t]{lcr}
 \includegraphics[width=70pt,height=70pt]{rysunki/PW} & POLITECHNIKA WARSZAWSKA & \includegraphics[width=70pt,height=70pt]{rysunki/ele}\\
& WYDZIAŁ ELEKTRYCZNY & \\
\end{tabular}
\end{table}

% \vfill
\begin{center}PRACA DYPLOMOWA MAGISTERSKA\end{center}
%\begin{center}MATEMATYKA\end{center}
\end{Large}
% \vfill
\begin{center}
\Huge
\textbf{Poprawa jakości obrazów cyfrowych poprzez metodę wmalowywania}
\end{center}
% \vfill\vfill
\vfill
\begin{center}
\Large
Autor:\\
\LARGE
Marek Szweda
\end{center}
\vfill
\begin{center}
\Large
Promotor: dr Sławomir Skoneczny
\end{center}
\vfill
\begin{center}
\large
Warszawa, listopad 2018
\end{center}
\newpage
\hfill
\begin{table}[b]
\centering
\begin{tabular}[t]{ccc}
............................................. & \hspace*{100pt} & .............................................\\
podpis promotora & \hspace*{100pt} & podpis autora
\end{tabular}
\end{table}


% \maketitle
\end{titlepage}
\thispagestyle{empty}
\newpage
\pagestyle{headings}
\setcounter{page}{1}
\hyphenation{Syl-ves-tra}
\hyphenation{Syl-ves-ter-a}

\begin{abstract}
Tu będzie jakieś streszczenie
\end{abstract}

%-----------Poczłtek człłci zasadniczej-----------

\chapter{Wprowadzenie do przetwarzania obrazów.}
W ostatnich latach analiza obrazów zyskuje na popularności ciągle zwiększając swój obszar w dziedzinie badań. Ogólnie proces analizy obrazu można przedstawić następującym modelem: \\
\begin{figure}[!h]
	\centering
	\includegraphics{rysunki/1_fig1.png}
\end{figure}
\\
Jest wiele rodzajów analizy obrazu takich jak model stochastyczny, transformacje, równania różniczkowe wyższego rzędu, analiza funkcjonalna. Jednym z podstawowych problemów w analizie obrazów jest ulepszenie uszkodzonego obrazu. Poprawa jakości poprzez metodę wmalowywania jest szeroko stosowana w aplikacjach do edycji obrazów, usuwania niechcianych obiektów z obrazów, tekstów, zarysowań, uszkodzeń, poprawy starych zdjęć oraz filmów. Przed przejściem do dokładniejszej analizy wmalowywania obrazu należy podać definicje obrazu cyfrowego.
\section{Obraz cyfrowy.}
Dwuwymiarowy obraz jest reprezentacją skończonej ilości dyskretnych wartości zwanych pikselami. Każdy z pikseli przypisany jest do konkretnego położenia w dwuwymiarowej przestrzeni $x = {i,j} \in D=\mathcal{R}^2$, gdzie $D$ oznacza przestrzeń obrazu. Wartość piksela $f(x)$ stanowi informację o natężeniu oraz nasyceniu kolorów w danym punkcie $x$. Najczęściej obraz przechowywany jest jako zbiór wartości $f(x) \in \langle 0,255 \rangle$, gdzie 0 oznacza najmniejszą wartość intensywności, a 255 największą wartość intensywności. Obraz w odcieniach szarości stanowi mapowanie $f: D \rightarrow \mathcal{R}$. W przypadku obrazów kolorowych obraz stanowi mapowanie $f: D \rightarrow \mathcal{R}^n$, gdzie $n$ określa ilość przestrzeni barw. Przykładem przestrzeni może być przestrzeń $RGB$, gdzie przy wykorzystaniu trzech kolorów $(n=3)$ uzyskuję się skończoną gammę innych kolorów. Biorąc pod uwagę trzy podstawowe kolory oraz 256 wartości ich intensywności obraz może modelować $256^3=16777216$ różnych kolorów. Jakość obrazu zależy od jego rozdzielczości. Rozdzielczość określa się jako liczbę wierszy i kolumn przypadających na obraz. Obrazy o dużej rozdzielczości charakteryzują się znikomą zdolnością do odróżnienia poszczególnego z pikseli obrazu, dzięki czemu w ogólnym wrażeniu tworzy gładki obraz.
\section{Wmalowywanie obrazów.}
Cyfrowe wmalowywanie obrazu jest artystycznym synonimem zapożyczonym z techniki wykorzystywanej przez profesjonalnych restauratorów odnawiających dzieła sztuki w muzeach. Niech $D$ oznacza całą przestrzeń obrazu będącego przekształceniem $f: D \rightarrow R^{n}$. Problem wmalowania obrazu polega na wypełnieniu pustej części zbioru $\Omega \subset D$ na podstawie informacji znajdującej się na zewnątrz $\Omega$. Do tak zdefiniowanego problemu istnieje wiele rozwiązań przedstawianych w literaturze. Wmalowywanie obrazów definiuje się jako automatyczne wypełnianie braków w obrazie na podstawie otoczenia, w sposób uniemożliwiający obserwatorowi znalezienie pierwotnie wybrakowanych miejsc. Przykłady obrazów poddanych operacji wmalowywania przedstawia \autoref{1_fig1} 
\begin{figure}[!h]
	\centering
	\includegraphics[scale=0.7]{rysunki/fig1}
	\caption{Przykłady obrazów poddanych operacji wmalowywania.}
	\label{1_fig1}
\end{figure}
\par
Obrazy przedstawiono w parze: po lewej obraz wejściowy, po prawej wynikowy obraz poddany operacji wmalowywania. Mogą nimi być uszkodzenia jak w przypadku a oraz b, napisy znajdujące się na obrazie - c, czy też obiekty, którym w konkretnym przypadku d jest postać. Przestrzeń do wmalowywania w obrazie wyznaczana jest manualnie poprzez użytkownika definiującego konkretny obiekt, który powinien według niego zostać usunięty. Program automatycznie nie jest w stanie wyznaczyć części, która powinna zostać przearanżowana. 
Techniki wmalowywania znajdują szeroki zakres zastosowań w przetwarzaniu nagrań filmowych, gdzie nieznany region na scenie musi zostać oszacowany w pewien sposób dostarczając spójności wizualnej użytkownikowi. Przykładami mogą być konieczność ukrywania błędów nagrań, strat wynikających z błędów urządzeń nagrywających, czy też usunięcia niepożądanych obiektów, które w trakcie nagrywania pojawiły się w kadrze. Głównym celem pracy jest osiągniecie algorytmu skutecznie odbudowującego uprzednio zdefiniowaną nieznaną przestrzeń obrazu. W tym celu dokonano przeglądu istniejących algorytmów wmalowywania opartych na rozwiązaniu odpowiednio zdefiniowanych problemów matematycznych. Wyniki badanych zagadnień uzyskiwane są na podstawie danych wejściowych w postaci zdefiniowanych obszarów obrazu otaczających brakujące regiony. Podstawowymi operacjami wykorzystywanymi w bardziej złożonych algorytmach rekonstrukcji są:
\begin{enumerate}
\item
Rozwiązanie cząstkowych równań różniczkowych wyższego rzędu bazujących na kontynuacji tekstur, geometrii, struktur obrazu.
\item
Analiza funkcjonalna, problem minimalizacji energii o szerokim zakresie sposobów definicji.
\item
Wyznaczenie podobieństwa pomiędzy obszarami w obrazie za pomocą wprowadzonej metryki 
\end{enumerate}
W pracy opisano przedstawione powyżej algorytmy, porównano oraz zaproponowano nowy model uzupełniania brakujących danych. Porównania dokonano na podstawie dwóch najistotniejszych właściwości: szybkości algorytmu oraz obiektywnej oceny poprawności otrzymanego wyniku. Zwrócono także uwagę na różne cechy obrazu, które mogą determinować dobór algorytmu do zadanego problemu. Warto zaznaczyć, iż do tej pory nie została przedstawiona jednoznaczna definicja problemu matematycznego pozwalająca w niezawodny sposób wyznaczyć braki w obrazie niezależnie od jego cech charakterystycznych.
\chapter{Przegląd istniejących algorytmów.}
Pierwszą gałęzią algorytmów zgodnie z rozróżnieniem wprowadzonym w  \cite{SalientStrucTexProp} są metody opierające się na rozwiązaniu równań różniczkowych wyższego rzędu. Wśród nich pojawia się próba przystosowania procesu dyfuzji do wypełniania braków w obrazie (źródła \cite{bertalmio2000image} lub \cite{BertalmioNavierStokes}), dzięki której przy wykorzystaniu zależności z działu mechaniki płynu można dokonać próby kontynuacji informacji z otoczenia w brakujące obszary. \\
Drugą gałęzią algorytmów są metody oparte na uzupełnianiu braków obrazu kawałek po kawałku skopiowanymi częściami istniejącego obrazu z miejsc o najlepszym dopasowaniu w miejsce braku. Pierwszy raz metoda syntezy obrazu kopiowanymi kawałkami została zaproponowana w \cite{efros1999texture}. Kolejność wypełniania braków nie jest obojętna i ma znaczny wpływ na ostateczną spójność obrazu. Jedna z najpopularniejszych metod określania priorytetu została przedstawiona w \cite{criminisi2004region}. Na przestrzeni czasu pojawiło się wiele metod minimalizujących zjawisko niespójności w obrazie takich jak np. \cite{StructurePropagationManual}. \\
Innym sposobem wyznaczenia braków jest analiza funkcjonalna definiująca problem minimalizacji energii stanowiąca największą grupę zdefiniowanych rozwiązań wmalowywania. Przykładem mogą być \cite{MathematicalModelsforNLTextureInpainting}, \cite{ColorTextureInpaintingNLCTVModel}, czy też \cite{arias2011variational}. W przytoczonych przykładach rozwiązanie problemu minimalizacji stanowi wynik w postaci wmalowanego obrazu. Innym przykładem może być problem minimalizacji zdefiniowany w \cite{SalientStrucTexProp} stanowiący pośredni proces w wypełnianiu obrazu. Tu problem minimalizacji, będący segmentacją obrazu, pozwala oddzielić strukturę i teksturę, pozwalając w następstwie na przeprowadzenie oddzielnej syntezy dwóch zbiorów danych, za pomocą róznych algorytmów. \\
Ostatnią grupą algorytmów jest grupa stanowiąca połączenie powyższych algorytmów. Najprostszym przykładem grupy może być przytoczone uprzednio \cite{NavierStokesAndTexturePropagation}, w którym zaproponowano poprzedzenie procesu wmalowywania segmentacją obrazu. Uzyskaną w procesie segmentacji teksturę uzupełnia się metodą najbliższego dopasowania natomiast strukturę uzyskuje na podstawie równań różniczkowych. Kolejnym przykładem może być publikacja \cite{arias2011variational}, w której autorzy proponują nielokalny model wyznaczający nieznany obszar obrazu wykorzystując rachunek wariacyjny, połączony ze zdefiniowaną metryką wyznaczającą odległości pomiędzy rozpatrywanymi skrawkami obrazu. \\
Większość metod wmalowywania opisanych w literaturze opiera się na algorytmach kontynuujących strukturę, geometrię bądź teksturę obrazu. Modele bazujące na geometrii i strukturze w uogólnieniu generują efekt uboczny w postaci braku kontynuacji tekstur, sprawiających wrażenie rozmytego obrazu. Do algorytmów broniących się przed efektem rozmycia można zaliczyć takie, w których wyznaczeniu konkretnego miejsca w nieznanym obszarze może towarzyszyć przebadanie całego zbioru punktów niemodyfikowanej części obrazu. Stąd metody kontynuujące tekstury w większości uważa się za metody nielokalne.
\chapter{Równania różniczkowe wyższego rzędu.}
\label{chap:navierstokes}
\section{Rozwiązanie równania Naviera-Stokesa }
W celu dokładnego nakreślenia idei wmalowywania w oparciu o równanie Naviera-Stokesa należy rozważyć poniższe równanie przepływu cieczy Newtonowskiej:
\begin{equation}
V\nabla V\mathrm{+}\frac{dV}{dt}\mathrm{=-}\frac{\mathrm{1}}{q}\nabla p\mathrm{+}F\mathrm{+}\nu {\nabla }^{\mathrm{2}}V
\label{NavierStokesEquation}
\end{equation}
\begin{equation}
\mathrm{V=\ (-}\frac{\mathrm{\partial }\mathrm{\Psi }}{\mathrm{\partial }\mathrm{y}},\frac{\mathrm{\partial }\mathrm{\Psi }}{\mathrm{\partial }\mathrm{x}}\mathrm{)}
\label{LiquidVelociy}
\end{equation}
gdzie $V$ oznacza prędkość lokalną, $t$ chwilę czasu, $q$ gęstość lokalną, $p$ ciśnienie lokalne, $F$ siłę zewnętrzną działającą lokalnie na ciecz, $\nu$ lepkość kinematyczną lokalną, a $\mathit{\Psi}$ linię prądu. Człon $V\nabla V$ odpowiada konwekcji lokalnego pędu wraz z ruchem cieczy, $\frac{1}{q}\nabla p$ wpływowi sił ciśnieniowych na zmianę pędu (kompensuje niezerową konwekcję),  $F$ sile zewnętrznej działającej na ciecz (np. grawitację) oraz $\nu {\nabla }^2V\ $ dyssypacji pędu cieczy od tarcia pomiędzy cząstkami. Traktując płyn jako nieściśliwy ($q\textrm{?}\infty $)  oraz pomijając działanie sił zewnętrznych ($F=0$)  równanie można uprościć do postaci:
\begin{equation}
 V\nabla V+\frac{dV}{dt}=\nu {\nabla }^2V
\label{NavierStokesEquationShort}
\end{equation}
Zgodnie z \cite{StreamfuntionVorticityForm} dokonując obustronnej rotacji równania otrzymujemy równanie w zależności od wirowości:
\begin{equation}
V\nabla \omega \mathrm{+}\frac{d\omega }{dt}\mathrm{=}\nu {\nabla }^{\mathrm{2}}V
\label{NavierStokesEquationVorticity}
\end{equation}
gdzie wirowość określa się wzorem:
\begin{equation}
\omega =\nabla \times V
\label{Vorticity}
\end{equation}
Zgodnie z \cite{ebrahimi2012navier} niech $I$ reprezentuje obraz cyfrowy będący macierzą o rozmiarze$m \mathrm{\times} n$. Wtedy $I_{i,j}$ zawiera wartość dodatnią całkowitą z przedziału od 0 do 255, stanowiącą informację o poziomie jasności danego piksela z obrazu. Wartość 0 opowiada odcieniu czarnemu, natomiast 255 odcieniu czystemu białemu. Niech D stanowi zbiór indeksów $(i,j)\ \in \ \left\{1,2\dots ,m\right\} \mathrm{\times}$ $\left\{1,2\dots ,n\right\}$. Obraz $I$ wtedy można traktować jako funkcję $I:D\to R$.
\par
W 2000 roku Bertalmio w \cite{BertalmioNavierStokes} wprowadza analogię pomiędzy wirowością a smukłością obrazu. Dokładniej przedstawia to \autoref{tab1}:
\begin{table}[!h]
	\centering
	\begin{tabular}{|cc|c|}
	\hline \hline

		& Navier-Stokes
		& Wmalowywanie w obrazie\\ \hline
		
		& Linia prądu $\ \mathit{\Psi}$ &  Jasność obrazu $I$ \\ \hline
	
		& Prędkość płynu $V = {\mathrm{\nabla }}^{\bot }\mathit{\Psi} = [u, v]$  & Prędkość płynu $V$ = ${\mathrm{\nabla }}^{\bot }I = [u, v]$ \\ \hline
		& Wirowość $\omega =\ {\mathrm{\nabla }}^2\mathit{\Psi}$ & Smukłość $\omega =\ {\mathrm{\nabla }}^2I$ \\ \hline
		
		& Lepkość płynu $\nu $ & Parametr dyfuzji anizotropowej $\nu $ \\
	\hline
	\end{tabular}
	\caption{Mapowanie zmiennych w zagadnieniu wmalowywnia obrazu.}
	\label{tab1}
\end{table}
gdzie ${\nabla }^{\bot }=(\frac{\partial }{\partial y},\frac{\partial }{\partial x})$.
Niech $\mathit{\Omega}\subset D$ stanowi wypełniany obszar obrazu (maskę). W wyniku rozwiązania dyskretnego równania Naviera-Stokesa w przestrzeni maski z warunkami brzegowymi zdefiniowanymi jako jasność pikseli sąsiadujących z obszarem maski uzyskuje się kontynuację linii o podobnej jasności (izolinii) w głąb odrestaurowywanego obszaru zgodnie z \autoref{3_fig1}.  Matematycznie kierunek izolinii jasności obrazu wyznacza ${\nabla }^{\bot }I$. W oparciu o \autoref{tab1} oraz \eqref{NavierStokesEquationVorticity} zagadnienia wmalowywania można sformułować jako problem stabilnego rozwiązania poniższego równania różniczkowego:
\begin{equation}
{\mathrm{(}\mathrm{\nabla }}^{\mathrm{\bot }}I\mathrm{)}\mathrm{\cdot }\nabla {\mathrm{(}\mathrm{\nabla }}^{\mathrm{2}}I\mathrm{)+}\frac{d{\mathrm{(}\mathrm{\nabla }}^{\mathrm{2}}I\mathrm{)}}{dt}\mathrm{=}\nu \mathrm{\nabla }\mathrm{(}g\mathrm{(}\nabla {\mathrm{(}\mathrm{\nabla }}^{\mathrm{2}}I\mathrm{))}\nabla {\mathrm{(}\mathrm{\nabla }}^{\mathrm{2}}I\mathrm{))} 
\label{NavierStokesInpainting}
\end{equation}
\begin{figure}[!h]
	\centering
	\includegraphics[scale=1]{rysunki/3_fig1}
	\caption{Propagacja jasności obrazu wgłąb nieznanego obszaru.}
	\label{3_fig1}
\end{figure}
W równaniu \eqref{NavierStokesInpainting} człon odpowiedzialny za tarcie pomiędzy cząstkami płynu $\nu {\nabla }^2V\ $ został zastąpiony dyfuzją anizotropową, która w kontekście przetwarzania obrazów pierwszy raz wprowadzona została przez Perona i Malika w 1987 roku. Dyfuzja anizotropowa ma znaczny wpływ na zachowanie krawędzi obrazu oraz poprawę jego ostrości. Za dyfuzję anizotropową odpowiada współczynnik $g$, który przedstawiany jest w różnych postaciach funkcji przewodności. W pracy wykorzystana zostanie postać:
\begin{equation}
g\left(s\right)=\frac{1}{1+\alpha \left|s\right|}
\end{equation}
gdzie $\alpha\ $, $K$ uprzednio zdefiniowane parametry dyfuzji (stałe), ${\mathrm{\nabla }}^{\bot }=({-\partial }_y,{\partial }_x)$. 
Dyskretne rozwiązanie równania \eqref{NavierStokesInpainting} jest analogiczne do dyskretnego rozwiązania przepływu płynu w przestrzeni $2D$. W tym celu należy wprowadzić chwile w czasie $t=n\bullet \Delta t$, gdzie $n=\left\{1,2,3,\dots ,N\right\}$, $\Delta t$ wartość przyrostu czasu pomiędzy dyskretnymi chwilami $n$ i $n+1$, $N$ moment osiągnięcia stanu ustalonego, matematycznie przedstawianego jako:
\begin{equation}
\frac{\partial I}{\partial t}\mathrm{+}{\mathrm{\nabla }}^{\mathrm{\bot }}I\mathrm{\nabla }\mathrm{\Delta }I\mathrm{\ }\mathrm{\cong }\mathrm{0}
\label{NavierStokesStability}
\end{equation}
Warto zauważyć, że człon ${\mathrm{\nabla }}^{\bot }I$ w równaniu \eqref{NavierStokesStability} odpowiada kierunkowi rozchodzenia się punktów o podobnej jasności, natomiast $\mathrm{\nabla }\Delta I$ to kierunek największej zmiany smukłości obrazu. Jeśli wektory są do siebie prostopadłe (do czego zbiega algorytm) iloczyn skalarny wynosi 0. 
W celu dokładnej analizy dyskretyzacji równanie \eqref{NavierStokesEquationVorticity} zostanie rozdzielone na dwa podrównania:
\begin{equation}
\frac{d{\mathrm{(}\mathrm{\nabla }}^2I)}{dt}=-{\mathrm{(}\mathrm{\nabla }}^{\bot }I)\cdot \nabla {\mathrm{(}\mathrm{\nabla }}^2I)+\left\{ad\right\}
\label{NavierDiffAdv}
\end{equation}
oraz
\begin{equation}
ad=\nu \mathrm{\nabla }(g(\nabla {\mathrm{(}\mathrm{\nabla }}^2I))\nabla {\mathrm{(}\mathrm{\nabla }}^2I))
\label{NavierAdv}
\end{equation}
Rozwiązanie powyższych równań dokonywane będzie na siatce obliczeniowej typu Eulera, a wszystkie wartości wyznaczanych zmiennych będą znajdować się w centrach komórki zdefiniowanej jako konkretny piksel obrazu, zgodnie z \autoref{3_fig1} 
\begin{figure}[!h]
	\centering
	\includegraphics[scale=0.7]{rysunki/fig2}
	\caption{Przykłady obrazów poddanych operacji wmalowywania.}
	\label{3_fig2}
\end{figure}
Równanie \eqref{NavierDiffAdv} to równanie różniczkowe cząstkowe typu parabolicznego. Zgodnie z teorią równanie można rozwiązać metodą różnic skończonych schematem centralnym bądź schematem do przodu. W przypadku równania parabolicznego oba schematy dostarczają stabilnego rozwiązania. W celu ułatwienia dalszych rozważań wprowadzono funkcję $f$ określoną w centrach siatki, z przypisami dolnymi wskazującymi na konkretne miejsce w siatce. Korzystając z rozwinięcia w szereg Taylora gradient funkcji $f$ w punkcie $(i,j)$  można przybliżyć następującym wzorem:
\begin{equation}
\nabla f_{i,j}=\left|\ {\frac{\partial f}{\partial x}|}_{i,j,}{\frac{\partial f}{\partial y}|}_{i,j}\right|
\label{gradF}
\end{equation}
gdzie:
\begin{equation}
{\frac{\partial f}{\partial x}|}_{i,j}=\frac{f_{i+1,j}+f_{i-1,j}}{2\Delta x}
\label{dfdx}
\end{equation}
Analogicznie:
\begin{equation}
{\frac{\partial f}{\partial y}|}_{i,j}=\frac{f_{i,j+1}+f_{i,j-1}}{2\Delta y}
\label{dfdy}
\end{equation}
Na podstawie powyższych wzorów składowe wektora ${\mathrm{\nabla }}^{\bot }I$, czyli kierunku, w którym należy propagować smukłość obrazu ${\mathrm{\nabla }}^2I$ wyznacza się z zależności:
\begin{equation}
u_{i,j}=\frac{I_{i,j+1}+I_{i,j-1}}{2\Delta y} 
\label{u}
\end{equation}
Oraz
\begin{equation}
 v_{i,j}=-\frac{I_{i+1,j}+I_{i-1,j}}{2\Delta x}
\label{v}
\end{equation}
Gdzie:
\begin{equation}\\
{\mathrm{\nabla }}^{\bot }I=|-u,v|
\label{gradI}
\end{equation}
Stosując pięciopunktowy analog różnicowy w metodzie skończonych różnic operator Laplace’a dla przyjętej siatki Eulera można przybliżyć wzorem (przy założeniu $\Delta x=\ \Delta y$):
\begin{align}
\begin{aligned}
{\mathrm{\nabla }}^2f_{i,j} &= \Delta f_{i,j} \\[1ex]
&={\frac{{\partial }^2f}{\partial x^2}|}_{i,j}+{\frac{{\partial }^2f}{\partial y^2}|}_{i,j} \\
&=\frac{f_{i+1,j+1}+f_{i-1,j+1}+f_{i+1,j-1}+f_{i-1,j-1}-4f_{i,j}}{\Delta x^2}\ 
\end{aligned}
\label{LaplaceOpr}
\end{align}
Korzystając z wyznaczonych powyżej zależności na wartości $u$ oraz $v$ wartość smukłości obrazu $\omega =\ {\mathrm{\nabla }}^2I$ można przedstawić w postaci: 
\begin{equation}
\Delta {I|}_{i,j}=\ {\frac{\partial v}{\partial x}|}_{i,j,}-\ {\frac{\partial u}{\partial y}|}_{i,j}
\label{discreteVorticity}
\end{equation}
Podobnie jak w przypadku liczenia pochodnej w przestrzeni powierzchni (obrazu) pierwszą pochodną w przestrzeni czasu przybliża się rozwinięciem w szereg Taylora. Niech przypis górny oznacza konkretną chwilę w czasie. Wtedy wartość pochodnej wynosi:
\begin{equation}
\ {{\frac{\partial f}{\partial t}|}^n_{i,j}=\ \frac{f^{n+1}_{i,j}-\ f^n_{i,j}}{\Delta t}}
\label{dfdt}
\end{equation}
Ostatecznie rozwiązanie dyskretnego równania parabolicznego \eqref{NavierDiffAdv} , gdzie $\Delta x= \Delta y=h$, z wykorzystaniem schematu centralnego ma postać:
\begin{align}
{\omega }^{n+1}_{i,j} &= {\omega }^n_{i,j}+\Delta t\biggl[
-\left(\frac{I_{i,j+1}+I_{i,j-1}}{2h}\right)\left(\frac{{\omega }_{i+1,j}
+{\omega }_{i-1,j}}{2h}\right)  \notag\\ 
&\qquad+ \left(\frac{I_{i+1,j}+I_{i-1,j}}{2h}\right)\left(\frac{{\omega }_{i,j+1}+{\omega }_{i,j-1}}{2h}\right)+{\left\{ad\right\}}_{i,j} \biggr]
\label{NavierDiffAdvCen}
\end{align}
Rozwiązanie równania \eqref{NavierDiffAdv} można przedstawić również w drugiej postaci wykorzystującej schemat „do przodu”, charakteryzujący się wyznaczaniem wartości pochodnej wirowości w zależności od wyznaczonego kierunku ${\mathrm{(}\mathrm{\nabla }}^{\bot }I)$.  Wtedy równanie \eqref{NavierDiffAdvCen} przyjmuje postać:
\begin{align}
{\omega }^{n+1}_{i,j} &= {\omega }^n_{i,j}+\Delta t\biggl[
-\left(\frac{I_{i,j+1}+I_{i,j-1}}{2h}\right)\left(\frac{{\omega }_{i+sgn\left(u^n\right),j}+{\omega }_{i,j}}{2h}\right)  \notag\\ 
&\qquad+ \left(\frac{I_{i+1,j}+I_{i-1,j}}{2h}\right)\left(\frac{{\omega }_{i,j+sgn(u^n)}+{\omega }_{i,j}}{2h}\right)+{\left\{ad\right\}}_{i,j} \biggr]
\label{NavierDiffAdvFor}
\end{align}
\par
Rozwiązanie równania \eqref{NavierAdv}, w którym zastąpiono postać zwykłej dyfuzji $\nu {\nabla }^2V$ wymaga uważniejszego potraktowania ze względu na większą podatność na niestabilność implementowanych metod dyskretyzacji. Równanie można przedstawić w postaci dywergencji pola wektorowego uzyskanego w wyniku gradientu wirowości z uwzględnionym współczynnikiem dyfuzji anizotropowej:
\begin{align}
\begin{aligned}
\left\{ad\right\} 
&= \nu \mathrm{\nabla }(g(\nabla {\mathrm{(}\mathrm{\nabla }}^2I))\nabla {\mathrm{(}\mathrm{\nabla }}^2I) \\[1ex]
&= \nu \mathrm{\nabla }\mathrm{\cdot}(g(|\nabla \omega |)\nabla \omega )   \\[1ex]
&= {\partial }_x\left(g\left(\left|\nabla \omega \right|\right){\partial }_x\omega \right)+{\partial }_y\left(g\left(\left|\nabla \omega \right|\right){\partial }_y\omega \right)
\end{aligned}
\label{Anisotropic}
\end{align}
\eqref{Anisotropic}
gdzie: ${\partial }_x=\frac{\partial }{\partial x}$ oraz analogicznie: ${\partial }_y=\frac{\partial }{\partial y}$.
Zgodnie z \cite{ebrahimi2012navier} powyższe równanie można rozwiązać w poniższych krokach:
Korzystając z zależności \eqref{dfdx} i \eqref{dfdy} wyznaczyć wartości $({\frac{d\omega }{dx})}_{i,j}$ oraz $({\frac{d\omega }{dy})}_{i,j}$
Na podstawie wartości z punktu 1 obliczyć moduł wektora dla przestrzeni Euklidesowej:
\begin{equation}
{\left|\mathrm{\nabla }\omega \right|}_{i,j}=\ \sqrt{\mathrm{\ }({\frac{\partial \omega }{\partial x})}^2_{i,j}+{\left(\frac{\partial \omega }{\partial y}\right)}^2_{i,j}\ }\
\label{magnitudedw}
\end{equation}
Na podstawie wartości z punktu 2 wyznaczyć wartość $$\ g{\left({\left|\mathrm{\nabla }\omega \right|}_{i,j}\right)}_{i,j}$$ wykorzystując \eqref{NavierStokesInpainting}. Korzystając z wartości wyznaczonych powyżej oraz ponownie z zależności \eqref{dfdx} i \eqref{dfdy} obliczyć:
\begin{align}
{\left\{ad\right\}}_{i,j} &= {\left({\partial }_x\left(g{\left({\left|\mathrm{\nabla }\omega \right|}_{i,j}\right)}_{i,j}{\left({\frac{d\omega }{dx})}_{i,j}\right)}_{i,j}\right)\right)}_{i,j} \notag \\[1ex]
&+ {\left({\partial }_y\left(g{\left({\left|\mathrm{\nabla }\omega \right|}_{i,j}\right)}_{i,j}{\left({\frac{d\omega }{dx})}_{i,j}\right)}_{i,j}\right)\right)}_{i,j}
\label{discreteAnisotropic}
\end{align}
\par
Innym sposobem dyskretyzacji równania \eqref{NavierAdv} może być metoda przedstawiona w \cite{van2005algorithms}, wykorzystująca asymetryczny schemat liczenia pierwszej pochodnej funkcji. Pierwsze pochodne asymetryczne lewe przyjmują postać:
\begin{equation}
{\frac{{\partial }^-f}{\partial x}|}_{i,j}=\frac{f_{i,j}+f_{i-1,j}}{\Delta x}
\label{leftdfdx}
\end{equation}
\begin{equation}
{\frac{{\partial }^-f}{\partial y}|}_{i,j}=\frac{f_{i,j}+f_{i,j-1}}{\Delta y}
\label{leftdfdy}
\end{equation}
Analogicznie prawe:
\begin{equation}
{\frac{{\partial }^+f}{\partial x}|}_{i,j}=\frac{f_{i+1,j}+f_{i,j}}{\Delta x} 
\label{rightdfdx}
\end{equation}
\begin{equation}
{\frac{{\partial }^+f}{\partial y}|}_{i,j}=\frac{f_{i,j+1}+f_{i,j}}{\Delta y}
\label{rightdfdy}
\end{equation}
Następnie powyższe zależności znajdują zastosowanie w wyznaczeniu członów\\ ${\partial }_y\left(g\left(\left|\nabla \omega \right|\right){\partial }_y\omega \right)$ oraz ${\partial }_x\left(g\left(\left|\nabla \omega \right|\right){\partial }_x\omega \right)+{\partial }_y$. Stosując naprzemiennie schemat lewy z prawym do liczenia wartości pochodnych wewnętrznych i zewnętrznych w wyniku otrzymuje się ogólny schemat centralny. Stosując powyższe ostatecznie równanie \eqref{NavierAdv} można przedstawić w następującej postaci dyskretnej:
\begin{align}
\begin{aligned}
{\left\{ad\right\}}_{i,j}
&= \frac{1}{2}\biggl[\left(g_{i,j}+g_{i+1,j}\right)\left({\omega }_{i+1,j}-{\omega }_{i,j}\right) \\[1ex]
&- \left(g_{i-1,j}+g_{i,j}\right)\left({\omega }_{i,j}-{\omega }_{i-1,j}\right)   \\[1ex]
&+ \left(g_{i,j}+g_{i,j+1}\right)\left({\omega }_{i,j+1}-{\omega }_{i,j}\right) \\[1ex]
&- \left(g_{i,j-1}+g_{i,j}\right)\left({\omega }_{i,j}-{\omega }_{i,j-1}\right)\biggl]
\end{aligned}
\label{discreteAnisotropic2}
\end{align}
Należy zauważyć, iż do wyznaczenia wartości $u$, $v$ oraz ${\mathrm{\nabla }}^2I$ wykorzystywanych do obliczeń \eqref{NavierDiffAdv} i \eqref{NavierAdv} w każdej kolejnej chwili czasu $n$, konieczna jest znajomość obrazu $I^n$. W związku z tym równolegle do równania \eqref{Vorticity} należy rozwiązywać poniższe niejednorodne równanie różniczkowe cząstkowe liniowe drugiego rzędu.
\begin{equation}
\Delta I^n={\omega }^n
\label{Poisson}
\end{equation}
Dla przestrzeni dwuwymiarowej równanie przyjmuje postać:
\begin{equation}
\frac{{\partial }^2I}{\partial x^2}+\frac{{\partial }^2I}{\partial y^2}=\ \omega
\label{Poisson2D}
\end{equation}
W celu przybliżenia drugiej pochodnej funkcji $f$ w punkcie $(i,j)$ należy rozwinąć funkcję $f$ w dwa szeregi Taylora względem punktu $(i+1,j)$ oraz $(i-1,j)$. Po rozwiązaniu sumy dwóch rozwinięć względem $\frac{{\partial }^2f}{\partial x^2}$ otrzymuje się poniższy sposób dyskretyzacji drugiej pochodnej:
\begin{equation}
{\frac{{\partial }^2f}{\partial x^2}\mathrm{|}}_{i,j}\mathrm{=}\frac{f_{i+1,j}-2f_{i,j}+f_{i-1,j}}{\Delta x^2}
\label{d2fdx2}
\end{equation}
Analogicznie:
\begin{equation}
{\frac{{\partial }^2f}{\partial y^2}\mathrm{|}}_{i,j}\mathrm{=}\frac{f_{i,j+1}-2f_{i,j}+f_{i,j-1}}{\Delta y^2}
\label{d2fdy2}
\end{equation}
Korzystając z \eqref{d2fdx2} oraz \eqref{d2fdy2} równanie \eqref{Poisson} w punkcie $(i,j)$ przyjmuje postać pięciopunktowego analogu różnicowego operatora $\Delta $ ($\Delta x=\ \Delta y=h)$:
\begin{equation}
I_{i+1,j}+I_{i-1,j}+I_{i,j+1}+I_{i,j-1}-4I_{i,j}=h^2{\omega }_{i,j}
\label{Laplace}
\end{equation}
Na podstawie równania \eqref{Laplace} można stworzyć równanie macierzowe postaci $Ax=B$, gdzie $x$ reprezentuje obraz $I$, $B$ smukłość obrazu, natomiast $A$ to macierz charakterystyczna współczynników. Istnieje wiele metod rozwiązywania równań Poissona takich jak metoda Jacobiego czy Gaussa-Seidla.  Wystarczającą wydajność i szybkość działania w celach rozwiązania równania można uzyskać stosując metodę SOR – sukcesywnej nadrelaksacji. Dyskretyzacja równania wygląda następująco:
\begin{align}
\begin{aligned}
I^{n+1}_{i,j}
&= \left(1-\ \beta \right)I^n_{i,j}+\beta \cdot \frac{1}{2}{\left(\frac{1}{\Delta x^2}+\frac{1}{\Delta y^2}\right)}^{-1}\\[1ex]
&\cdot \left[\frac{1}{\Delta x^2}{(I}^n_{i+1,j}+I^{n+1}_{i-1,j})+\frac{1}{\Delta y^2}{(I}^n_{i,j+1}+I^{n+1}_{i,j-1})+{\omega }^n_{i,j}\right]
\end{aligned}
\label{DiscreteSOR}
\end{align}
Metoda w swoim równaniu przyjmuje parametr wagowy $\beta$ odpowiadający za zbieżność algorytmu. Dobór nie jest losowy i zawiera się w przedziale $(0,2)$. Zgodnie z literaturą parametr ten powinno przyjmować się zgodnie z zależnością:
\begin{equation}
{\omega }_{opt}=2{\left(1+\frac{\pi }{N}\right)}^{-1}
\label{BetaChoose}
\end{equation}
gdzie $N$ to liczba kolumn przyjętej siatki obliczeniowej. 
\par
Operacje wmalowywania bardzo często wykonywane są w punktach maski tworzących nieregularne kształty, mogących znajdować się w różnych częściach obrazu. Stąd powyżej przedstawiony schemat obliczeń wykonywany jest dla wszystkich pikseli obrazu. Po każdej iteracji uzyskane wartości $I^{n+1}$ w znanych punktach przepisywane są z oryginalnego obrazu $I_{o}$, zgodnie z zależnością poniżej.
\begin{equation}
I^{n+1}(D/\mathrm{\Omega }\mathrm{)\ }\ ={\ I}_o(D/\mathrm{\Omega }\mathrm{)}
\label{retrieveMask}
\end{equation}
\par
Podsumowując w celu wyznaczenia niewiadomych wartości obrazu w punktach zdefiniowanych przez maskę należy powtarzać następujące iteracje do uzyskania stanu ustalonego:
\begin{enumerate}
\item
Rozwiązać równanie \eqref{discreteAnisotropic} 
\item
Na podstawie równania \eqref{NavierDiffAdvCen} zamiennie z \eqref{NavierDiffAdvFor} wyznaczyć wartości $\omega_{i,j}^{n+1}$ dla każdego punktu $(i,j)$ 
\item
Korzystając z \eqref{DiscreteSOR} wyznaczyć jasność każdego piksela $I_{i,j}^{n+1}$.
\item
Do uzyskanego obrazu w punkcie 3 przepisać znane wartości z obrazu oryginalnego
\end{enumerate}
Powyższy algorytm przedstawiono dla obrazów w odcieniach szarości. W celu implementacji rozwiązania dla obrazów kolorowych, których funkcję definiuje się jako przekształcenie w pole wektorowe $[R,G,B]$, czyli $I:D\to R^3$  zgodnie z propozycją w \cite{fishelov2006image} można w pierwszym kroku przekształcić do współrzędnych sferycznych (CIELab) $\left[I_{1},I_{2},I_{3} \right]$ korzystając z zależności:
\begin{equation}
{I_{1_{i,j}}=r}_{i,j}=\ \sqrt{R^2_{i,j}+G^2_{i,j}+B^2_{i,j}}
\label{TIone}
\end{equation}
\begin{equation}
I_{2_{i,j}}=\ {\mathrm{sin} {\mathrm{\Theta }}_{i,j}\ }=\ {\mathrm{sin} {{\mathrm{tan}}^{-1} \frac{G_{i,j}}{R_{i,j}}\ }\ } 
\label{TItwo}
\end{equation}
\begin{equation}
I_{3_{i,j}}=\ {\mathrm{sin} {\phi }_{i,j}\ }=\ {\mathrm{sin} {{\mathrm{cos}}^{-1} \frac{B_{i,j}}{r_{i,j}}\ }\ } 
\label{TIthree}
\end{equation}
Następnie dysponując komponentami $I_1$, $I_2$, $I_3$ wyznaczonymi z powyższych zależności, dla każdego z nich oddzielnie należy wykonać wcześniej opisane iteracje. W celu odwrotnego przekształcenia $\left[I_1,I_2,I_3 \right]\to\left[R,G,B\right]$ wystarczy wykonać poniższe obliczenia:
\begin{equation}
 B_{i,j}=\ r_{i,j}{\mathrm{cos} {\mathrm{\Theta }}_{\mathrm{i,j}}\ }{\mathrm{cos} {\phi }_{\mathrm{i,j}}\ }
\label{TInvIone}
\end{equation}
\begin{equation}
R_{i,j}=\ r_{i,j}{\mathrm{cos} {\mathrm{\Theta }}_{\mathrm{i,j}}\ }{\mathrm{sin} {\phi }_{\mathrm{i,j}}\ }
\label{TInvItwo}
\end{equation}
\begin{equation}
G_{i,j}=\ r_{i,j}{\mathrm{sin} {\theta }_{\mathrm{i,j}}\ } 
\label{TInvIthree}
\end{equation}
Operację wmalowywania można wykonać na pierwotnych komponentach $[R,G,B]$ lecz matematyczna transformacja przestrzeni charakteryzuje się lepszymi właściwościami związanymi z postrzeganiem różnicy barw $\delta E$ przez ludzkie oko:
\begin{equation}
\Delta E=\ \sqrt{{\left(\Delta I_1\right)}^2+{\left(\Delta I_2\right)}^2+{\left(\Delta I_3\right)}^2}
\label{deltaE}
\end{equation}
\chapter{Analiza funkcjonalna.}
\section{Wmalowywanie struktury i tekstury obrazu.}\label{chap:StructureTextureNavierStokes}
\subsection{Segmentacja obrazu na strukturę i teksturę.}
Metoda jednoczesnego wmalowywania struktur i tekstur pierwszy raz przedstawiona została przez Bertalmio i innych w 2003 roku w \cite{NavierStokesAndTexturePropagation}. Opiera się na wmalowywaniu struktury w oparciu o algorytm przedstawiony w \cite{bertalmio2000image} przy jednoczesnej propozycji prostej syntezy tekstury. Niech obraz $I:R^2\to R,\ \ I\in L^2(R^2)$. Proces wypełniania brakującego regionu $\mathrm{\Omega }$ poprzedzony jest dekompozycją obrazu:
\begin{align}
I\left(i,j\right)=u\left(i,j\right)+v\left(i,j\right) 
\label{STRUCTURETEXTURE1}
\end{align}
uzyskaną na podstawie rozwiązania problemu minimalizacji energii:
\begin{align} 
{\mathop{\mathrm{min}}_{u} \Biggl\{E\left(u\right)=\int{\left|\mathrm{\nabla }u\right|+\lambda {\left|\left|v\right|\right|}^2_{L^2}}\Biggr\}\ }
\label{STRUCTURETEXTURE2}
\end{align}
gdzie: $\int{\left|\mathrm{\nabla }u\right|}$ stanowi funkcjonał z przestrzeni $BV(R^2)$ pozwalający usunąć z oryginalnego obrazu szum i powtarzające się w małej skali detale, przy jednoczesnym zachowaniu głównych cech oraz ostrych krawędzi, ${\left|\left|v\right|\right|}^2_{L^2}$ człon odpowiadający dokładności odwzorowania, $\lambda $ stanowi uprzednio definiowany parametr. Dla odpowiednio małych wartości $\lambda $ problem minimalizacji prowadzi do uzyskania jednorodnego komponentu $u$ reprezentującego odfiltrowany obraz oraz komponentu $v$ reprezentującego wahania w postaci szumu oraz tekstur. Zgodnie z dowodem Mayera w przypadku gdy pożądany jest wspomniany kształt funkcji $v$, można udowodnić jej  przynależność do przestrzeni Banacha oznaczanej $G$. W związku z tym (pomijając wyprowadzenia) problem minimalizacji można przedstawić w ostatecznej postaci minimalizacji energii:
\begin{align}
\begin{aligned} 
\mathop{\mathrm{min}}_{u,g_1,g_2} \Biggl\{E &= \int{\left|\mathrm{\nabla }u\right|+\lambda \int{{\left|I-u-{\partial }_xg_1-{\partial }_yg_2\right|}^2dxdy}} \\
&+ \mu {\left[\int{{\sqrt{g^2_1+g^2_2}}^pdxdy}\right]}^{\frac{1}{p}}\Biggr\}
\end{aligned}
\end{align}
gdzie:
\begin{align}
v=div\left(\mathop{g}\limits^{\rightharpoonup}\right),\ \mathop{g}\limits^{\rightharpoonup}=\left(g_1,g_2\right),\ g_1=-\frac{1}{2\lambda }\frac{u_x}{\left|\mathrm{\nabla }u\right|},\ g_2=-\frac{1}{2\lambda }\frac{u_y}{\left|\mathrm{\nabla }u\right|}\
\label{VG1G2}
\end{align}
oraz $p\to \mathrm{\infty }$. Stosując podstawowe równanie rachunku wariacyjnego postaci równania Eulera-Lagrange'a uzyskuje się odpowiadające mu postacie funkcji wykorzystywane do minimalizacji energii:
\begin{align}
u=I-u-{\partial }_xg_1-{\partial }_yg_2+\frac{1}{2\lambda }div\left(\frac{\mathrm{\nabla }u}{\left|\mathrm{\nabla }u\right|}\right)
\end{align}
\begin{align}
{\mu H\left(g_1,g_2\right)g}_1=2\lambda \left[\frac{\partial }{{\partial }_x}\left(u-I\right)+{\partial }^2_{xx}g_1+{\partial }^2_{xy}g_2\right]
\end{align}
\begin{align}
\mu H\left(g_1,g_2\right)g_2=2\lambda \left[\frac{\partial }{{\partial }_y}\left(u-I\right)+{\partial }^2_{xy}g_1+{\partial }^2_{yy}g_2\right]
\end{align}
gdzie $\mu$ stanowi uprzednio definiowany parametr dyskretyzacji, $H\left(g_1,g_2\right)$ opisuje się wzorem:
\begin{align}
H\left(g_1,g_2\right)={{{\left|\left|\sqrt{g^2_1+g^2_2}\right|\right|}_p}^{1-p}}{\left(\sqrt{g^2_1+g^2_2}\right)}^{p-2}
\end{align}
Zgodnie z \cite{vese2003modeling} w celach dyskretyzacji parametr $p$ przyjęto równy 1, ze względu na brak znaczących różnic wyniku w przypadku stosowania większych wartości. Wtedy:
\begin{align}
H\left(g_1,g_2\right)=\frac{1}{\sqrt{g^2_1+g^2_2}}
\end{align}
Formalnie, jednym z równań Eulera-Lagrange'a uzyskiwanym podczas minimalizacji wspomnianej energii $E$ jest:
\begin{align}
u=I+\frac{1}{2\lambda }div\left(\frac{\mathrm{\nabla }u}{\left|\mathrm{\nabla }u\right|}\right)
\end{align}
Stąd można wywnioskować:
\begin{align}
v=-\frac{1}{2\lambda }div\left(\frac{\mathrm{\nabla }u}{\left|\mathrm{\nabla }u\right|}\right)
\end{align}
Korzystając z zależności przedstawionych w \eqref{VG1G2} łatwo zauważyć $g^2_1+g^2_2=\frac{1}{2\lambda }$. Stąd:
\begin{align}
H\left(g_1,g_2\right)=\sqrt{2\lambda }
\end{align}
\begin{align}
u=I-u-{\partial }_xg_1-{\partial }_yg_2+\frac{1}{2\lambda }div\left(\frac{\mathrm{\nabla }u}{\left|\mathrm{\nabla }u\right|}\right)
\label{EU}
\end{align}
\begin{align}
\mu \sqrt{2\lambda }g_1=2\lambda \left[\frac{\partial }{{\partial }_x}\left(u-I\right)+{\partial }^2_{xx}g_1+{\partial }^2_{xy}g_2\right]
\label{EG1}
\end{align}
\begin{align}
\mu \sqrt{2\lambda }g_2=2\lambda \left[\frac{\partial }{{\partial }_y}\left(u-I\right)+{\partial }^2_{xy}g_1+{\partial }^2_{yy}g_2\right]
\label{EG2}
\end{align}
Jako wartości początkowe iteracyjnego algorytmu można przyjąć następujące przypuszczenie:
\begin{align}
u^0=f,\ g_1=-\frac{1}{2\lambda }\frac{f_{\mathrm{x}}}{\left|\mathrm{\nabla }f\right|},\ g_2=-\frac{1}{2\lambda }\frac{f_{\mathrm{y}}}{\left|\mathrm{\nabla }f\right|}
\end{align}
Następnie stosując zależności wyznaczania pochodnych \eqref{dfdx}, \eqref{dfdy}, \eqref{leftdfdx}, \eqref{leftdfdy} oraz poniższą metodę aproksymacji pochodnej drugiego stopnia:
\begin{align}
\begin{aligned} 
{\partial }_{xy}g_1\left(i,j\right) &\cong \frac{1}{2h^2}\ \bigg[2g_1\left(i,\ j\right)+g_1\left(i-1,\ j-1\right)+g_1\left(i+1,\ j+1\right)-g_1\left(i,\ j-1\right) \\ 
&-g_1\left(i-1,\ j\right)-g_1\left(i+1,\ j\right)-g_1\left(i,\ j+1\right)\bigg]
\end{aligned}
\end{align}
równania \eqref{EU}, \eqref{EG1} i \eqref{EG2} można przedstawić w następującej dyskretnej postaci:
\begin{align}
\begin{aligned}
u^{n+1}\left(i,j\right) &= \left[\frac{1}{\ 1\ +\ \left(\frac{1}{2\lambda h^2}\right)\cdot \left(c_1\left(i,j\right)+c_2\left(i,j\right)+c_3\left(i,j\right)+c_4\left(i,j\right)\right)\ }\right] \\ 
&\cdot \biggl[I\left(i,j\right)-\ \left(\frac{g^n_1\left(i+1,j\right)\cdot g^n_1\left(i-1,j\right)}{2h}\right)-\ \left(\frac{g^n_2\left(i,j+1\right)-g^n_2\left(i,j-1\right)}{2h}\right) \\ 
&+\ \left(\frac{1}{2\lambda h^2}\right)\cdot \Bigl[c_1\left(i,j\right)\cdot u^n\left(i+1,j\right)+c_2\left(i,j\right)\cdot u^n\left(i-1,j\right) \\
&+c_3\left(i,j\right)\cdot \lambda {\cdot u}^n\left(i,j+1\right)+c_4\left(i,j\right)\cdot u^n\left(i,j-1\right)\Bigr]\biggr]
\end{aligned}
\end{align}
\begin{align}
\begin{aligned}
g^{n+1}_1\left(i,j\right) &= \left[\frac{2\lambda }{\mu \sqrt{2\lambda }+\ 4\frac{\lambda }{2h}}\right]\cdot \Biggl[\frac{u^n\left(i+1,j\right)-u^n\left(i-1,j\right)}{2h}-\frac{I\left(i+1,j\right)-I\left(i-1,j\right)}{2h} \\
&+\frac{g_1\left(i+1,j\right)+g_1\left(i-1,j\right)}{h^2}\frac{1}{2h^2}\cdot \Bigl[2g^n_2\left(i,j\right)+\ g^n_2\left(i-1,j-1\right) \\ 
&+ g^n_2\left(i+1,j+1\right)
g^n_2\left(i,j-1\right)-\ g^n_2\left(i-1,j\right)+\ g^n_2\left(i+1,j\right) \\
&-g^n_2\left(i,j+1\right)\Bigr]\Biggr]
\end{aligned}
\end{align}
\begin{align}
\begin{aligned}
g^{n+1}_2\left(i,j\right) &=\left[\frac{2\lambda }{\mu \sqrt{2\lambda }\ +\ 4\frac{\lambda }{2h}}\right]\cdot \Biggl[\frac{u^n\left(i,j+1\right)-u^n\left(i,j-1\right)}{2h}-\frac{I\left(i,j+1\right)-I\left(i,j-1\right)}{2h} \\ 
&+\frac{g_2\left(i,j+1\right)+g_2\left(i,j-1\right)}{h^2}+\frac{1}{2h^2}\cdot \Bigl[2g^n_1\left(i,j\right)+\ g^n_1\left(i-1,j-1\right)+ g^n_1\left(i+1,j+1\right) \\
&-\ g^n_1\left(i,j-1\right)-\ g^n_1\left(i-1,j\right)+\ g^n_1\left(i+1,j\right)-\ g^n_1\left(i,j+1\right)\Bigr]\Biggr]
\end{aligned}
\end{align}
gdzie:
\begin{align}
\begin{aligned}
c^n_1\left(i,j\right)=\frac{1}{\sqrt{{\left(\frac{u^n\left(i+1,j\right)-u^n\left(i,j\right)}{h}\right)}^2+\ {\left(\frac{u^n\left(i,j+1\right)-u^n\left(i,j-1\right)}{2h}\right)}^2+\ \varepsilon }}
\end{aligned}
\end{align}
\begin{align}
\begin{aligned}
c^n_2\left(i,j\right)=\frac{1}{\sqrt{{\left(\frac{u^n\left(i,j\right)-u^n\left(i-1,j\right)}{h}\right)}^2+\ {\left(\frac{u^n\left(i-1,j+1\right)-u^n\left(i-1,j-1\right)}{2h}\right)}^2+\ \varepsilon }}
\end{aligned}
\end{align}
\begin{align}
\begin{aligned}
c^n_3\left(i,j\right)=\frac{1}{\sqrt{{\left(\frac{u^n\left(i+1,j\right)-u^n\left(i-1,j\right)}{2h}\right)}^2+\ {\left(\frac{u^n\left(i,j+1\right)-u^n\left(i,j\right)}{h}\right)}^2+\ \varepsilon }}\end{aligned}
\end{align}
\begin{align}
\begin{aligned}
c^n_4\left(i,j\right)=\frac{1}{\sqrt{{\left(\frac{u^n\left(i+1,j-1\right)-u^n\left(i-1,j-1\right)}{2h}\right)}^2+\ {\left(\frac{u^n\left(i,j\right)-u^n\left(i,j-1\right)}{h}\right)}^2+\ \varepsilon }}
\end{aligned}
\end{align}
W celu uniknięcia problemu dzielenia przez zero w powyższej dyskretyzacji wprowadzono parametr $\varepsilon \longrightarrow 0$. 
Po przeprowadzeniu powyższej segmentacji obrazu dla uzyskanych członów $u$ i $v$ można zastosować różne algorytmy wmalowywania braków. Autorzy w \cite{NavierStokesAndTexturePropagation} proponują do wmalowywania struktur zastosować algorytm przedstawiony w \cite{bertalmio2000image}, natomiast do uzyskania brakującej tekstury propuonują następujący algorytm syntezy obszaru $\mathrm{\Omega }$ \\:
\begin{figure}[!h]
	\centering
	\includegraphics[scale=1]{rysunki/5_fig1}
	\caption{Prosty algorytm wmalowywania tekstury obrazu.}
	\label{5_fig1}
\end{figure} \\
Zgodnie z \autoref{5_fig1} dla każdego piksela znajdującego się na granicy $\mathrm{\Omega }$ tworzone jest okno stanowiące szablon wykorzystywany do odnalezienia najlepszego dopasowania z pośród całego obrazu $v$. W przypadku odnalezienia takiego dopasowania uzyskany piksel kopiowany jest w miejsce poszukiwanego piksela. Algorytm można wykonywać pobierając piksele z granicy w kolejności zgodnej ze wskazówkami zegara, postępując w głąb obszaru $\mathrm{\Omega }$, aż do wypełnienia wszystkich pikseli. 
W przypadku obrazów kolorowych pierwszym krokiem wykonania operacji wmalowywania jest transformacja do współrzędnych sferycznych zgodnie z zależnościami \eqref{TIone}, \eqref{TItwo} i \eqref{TIthree} ze względu na ich lepsze właściwości. Następnie każda z trzech uzyskanych warstw jest rozbijana na własną teksturę i strukturę. W przypadku algorytmu dokonującego syntezy tekstury oddzielnie dla każdej z 3-ech segmentowanych warstw uzyskiwane wyniki charakteryzują się pojawiającymi się niespójnościami kolorów. Stąd w przypadku odrestaurowywania uzyskanych części $v$, zlokalizowanie piksela będącego najlepszym dopasowaniem aktualnie badanego, nieznanego piksela, odbywa się na podstawie pierwszej warstwy, a wszystkie 3 uzupełniane są analogicznie do obliczeń uzyskanych na podstawie pierwszej warstwy. Kroki algorytmu można przedstawić następująco:
\begin{enumerate}
\item
Przekształcenie warstw $R,G,B$ obrazu na współrzędne sferyczne $I_1,I_2,I_3$.
\item
Wyznaczenie $u_1,v_1,\ u_2,v_2,u_3,v_3$ na podstawie $I_1,I_2,I_3$.
\item
Wmalowanie nieznanych obszarów $\mathrm{\Omega }$ w warstwach $u_1,u_2,u_3$ dowolnie dobraną metodą.
\item
Wmalowanie obszaru $\mathrm{\Omega }$ w $v_1,v_2,v_3$ na podstawie dowolnego algorytmu syntezy tekstury $v_1$.
\end{enumerate}
\section{Model NLCTV.}
Pojęcie wahania funkcji $TV$ w analizie obrazów pierwszy raz wprowadzone zostało przez Rudin, Osher i Fatemi’ego w \cite{rudin1992nonlinear}, gdzie proponowany model znajduje zastosowanie w usuwaniu szumów z obrazu. Następnie model $TV$ zostaje zaproponowany do wmalowywania obrazu w \cite{MathematicalModelsforNLTextureInpainting} przez Chan i Shen’a. Problem doboru parametrów dla modelu $TV$, właściwości oraz proces dyskretyzacji problemu minimalizacji jest dokładnie przedstawiony w \cite{getreuer2012total}. Algorytm bazujący na lokalnych funkcjonałach $TV$  charakteryzuje się zdolnością do kontynuacji geometrycznych struktur obrazu i krawędzi. Zgodnie z przedstawioną literaturą wadą algorytmu jest brak możliwości propagacji tekstury w nieznany obszar $\Omega$. Warto wspomnieć, iż w przypadku usuwania szumów z obrazów wykorzystanie lokalnych operatorów nie pozwala zachować tekstur. Problem jednoczesnej propagacji geometrii i tekstury można rozwiązać przy zastosowaniu nielokalnego modelu, który zostanie poddany analizie w niniejszej pracy. \\
Klasyczny nielokalny model wahania funkcji został intensywnie przebadany dla obrazów w odcieniach szarości. W przypadku obrazów kolorowych jednym z pierwszych zaproponowanych modeli jest model Mumford-Shah dokładnie opisany w \cite{jung2011nonlocal}. Model ten dla każdej z warstw obrazu kolorowego przeprowadza oddzielną analizę, w wyniku prowadząc do niejednorodnego kontrastu kolorów obrazu w przestrzeni wmalowywanej $\Omega$ z jego otoczeniem $D/\mathrm{\Omega}$. Problem uzyskania jednakowego kontrastu rozwiązano poprzez propozycję nowego, szybkiego modelu w \cite{duan2015fast} wprowadzającego zależność pomiędzy wszystkimi warstwami obrazu kolorowego. W celu analizy nowego, nielokalnego modelu wahania funkcji dla obrazów kolorowych $NLCTV$ zaproponowanego w \cite{duan2015fast} należy uprzednio wprowadzić oznaczenia i zależności nielokalnych operatorów. 
Zgodnie z poprzednim działem niech $D$ stanowi dziedzinę obrazu. Wtedy obraz w odcieniach szarości możemy przedstawić jako przekształcenie $I\left(x\right):D\longrightarrow R,\ x\in R$ zdefiniowaną dla każdego piksela $x$ ze zbioru $D$. Wtedy pojęcie nielokalnego gradientu pomiędzy pikselem $x$ i $y$, gdzie $x,y\in D$ z definicji przedstawia się zależnością:
\begin{equation}
{\mathrm{\nabla }}_{NL}I\left(x,y\right)\triangleq \left[I\left(y\right)-I\left(x\right)\right]\sqrt{w(x,y)}
\label{NLGRAD}
\end{equation}
Warto zauważyć, że wynikiem powyższej zależność nie jest wektor, a wartość skalarna. Wyrażenie stanowi proste mapowanie $DxD\longrightarrow R$. Wartość wagi $w(x,y)$ z definicji wyraża się poniższą zależnością:
\begin{equation}
w\left(x,y\right)\triangleq {\mathrm{exp} \left\{-\frac{G_{\sigma }*{\left|I\left(x+\ \cdot \right)-I\left(y+\ \cdot \right)\right|}^2}{r^2}\right\}\ }
\label{NLWEIGHT}
\end{equation}
\begin{figure}[!h]
	\centering
	\includegraphics[scale=1]{rysunki/3_fig3.png}
	\caption{Kształt okien wykorzystywanych do obliczania wartości $w(x,y)$.}
	\label{3_fig3}
\end{figure}
Wartość $r$ to uprzednio definiowana stała skalująca wartości podobieństwa pomiędzy pikselami. Podobieństwo wyznaczane jest na podstawie utworzonych okien scentrowanych względem piksela $x$ oraz $y$ oznaczanych operatorem "$\cdot$" zgodnie z \autoref{3_fig3}. Normę macierzową występującą w powyższej zależności można wyznaczyć korzystając z normy Frobeniusa:
\begin{equation}
{\|I\left(x+\ \cdot \right)-I\left(y+\ \cdot \right)\|}=\ \sum^n_{i=1}{\sum^n_{j=1}{{\left(I_{(x+\ \cdot) }\left(i,j\right)-I_{(y+\ \cdot)}\left(i,j\right)\right)}^2}}
\label{FROBENIUS}
\end{equation}
gdzie wartość $n$ odpowiada wielkości badanego okna i stanowi uprzednio definiowany parametr. Zmienna $G_\sigma$ reprezentuje macierz o rozmiarze zgodnym z operatorem otoczenia danego piksela "$\cdot$". Wartości wewnątrz macierzy pozwalają stopniować wpływ każdego z rozpatrywanych pikseli na uzyskiwany wynik poprzez przyznawanie większego priorytetu pikselom centralnym, przy deprecjonowaniu tych bardziej oddalonych od centrum. Dla $G_\sigma$ zachodzi:
\begin{align}
\int_{D}G_{\sigma}(h)dh = 1
\end{align}
Rozważając okno Gauss'owskie $G_\sigma$ można opisać zależnością:
\begin{align}
G_\sigma(h)=\frac{1}{Z}\exp(-\frac{\|h\|}{2\sigma^2})
\label{oknoGaussowskie}
\end{align}
gdzie $\sigma$ odpowiada odchyleniu standardowemu, a $Z$ współczynnikowi normalizującemu. Podobnie jak w przypadku nielokalnego gradientu funkcja wagi stanowi mapowanie $DxD\longrightarrow R$. Kolejnymi ważnymi nielokalnymi operatorami wykonanymi w punkcie $x$ są: 
\begin{itemize}
\item
iloczyn skalarny dwóch nielokalnych mapowań $\overrightarrow{p}:DxD\longrightarrow R$ (mapowaniem $\overrightarrow{p}$ może być wspomniana funkcja wagi, bądź nielokalny gradient):
\begin{equation}
\left({\overrightarrow{p}}_1\cdot {\overrightarrow{p}}_2\right)(x)\triangleq \int_D{p_1(x,y)\cdot p_2\left(x,y\right)dy}
\label{NLPRODUCT}
\end{equation}
\item
moduł mapowania $\overrightarrow{p}$:
\begin{equation}
\left|\overrightarrow{p}\right|\left(x\right)\triangleq \sqrt{\overrightarrow{p}\cdot \overrightarrow{p}}=\sqrt{\int_D{{\left(p\left(x,y\right)\right)}^2dy}} 
\label{NLMOD}
\end{equation}
\item
dywergencja mapowania $\overrightarrow{p}$:
\begin{equation}
({\mathrm{\nabla }}_{NL}\cdot \overrightarrow{p})(x)\ \triangleq \int_D{\left(p\left(x,y\right)-p\left(y,x\right)\right)\sqrt{w(x,y)}dy}
\label{NLDIV}
\end{equation}
\item
laplasjan mapowania
\begin{equation}
{\mathrm{\Delta }}_{NL}\overrightarrow{p}(x)\ \triangleq \frac{1}{2}{\mathrm{\nabla }}_{NL}\cdot \left({\mathrm{\nabla }}_{NL}I\left(x\right)\right)=\int_D{\left(I\left(y\right)-I\left(x\right)\right)w(x,y)dy}
\label{NLLAP}
\end{equation}
\end{itemize}
Warto zauważyć, iż w przypadku mapowań w postaci nielokalnego gradientu \eqref{NLGRAD} oraz wagi \eqref{NLWEIGHT} zachodzą odpowiednio zależności:
\begin{align}
\left(p\left(x,y\right)-p\left(y,x\right)\right) &= \left({\mathrm{\nabla }}_{NL}I\left(x,y\right)-{\mathrm{\nabla }}_{NL}I\left(y,x\right)\right)  \notag \\ 
&= \left({\mathrm{\nabla }}_{NL}I\left(x,y\right)+{\mathrm{\nabla }}_{NL}I\left(x,y\right)\right) \notag \\
&=2{\mathrm{\nabla }}_{NL}I\left(x,y\right)\
\label{NLPOM}
\end{align}
Stąd w szczególnym przypadku nielokalną dywergencję można przedstawić: 
\begin{equation}
({\mathrm{\nabla }}_{NL}\cdot \overrightarrow{p})(x)\ \triangleq \int_D{2\left(p\left(x,y\right)\right)\sqrt{w(x,y)}dy}
\label{NLDIVSMART}
\end{equation}
\begin{equation}
w(x,y) = w(y,x)
\label{SMARTWEIGHT}
\end{equation}
Nielokalna dywergencja stanowi mapowanie $DxD\longrightarrow D$.
W celu dyskretyzacji powyższych równań należy zgodnie z \cite{gilboa2008nonlocal} wprowadzić pojęcie okna poszukiwania ${\mathrm{N}}_i$, gdzie $i\in D,\ j\in {\mathrm{N}}_i$. Rozmiar okna stanowi uprzednio definiowany parametr. Dla wszystkich pikseli w oknie zachodzi zależność ${\mathrm{N}}_i\coloneqq \left\{j:w_{i,j}>0\right\}$. Wprowadzenie okna skutkuje ograniczeniem wcześniej wprowadzonego mapowania $DxD\longrightarrow R$ do $\mathrm{N}xD\longrightarrow R$.
\begin{figure}[!h]
	\centering
	\includegraphics[scale=0.5]{rysunki/3_fig4.png}
	\caption{Przykładowe okna ${\boldsymbol{\mathrm{N}}}_{\boldsymbol{x}}\boldsymbol{,\ }{\boldsymbol{\mathrm{N}}}_{\boldsymbol{y}}$ utworzone dla pikseli $\boldsymbol{x},\boldsymbol{y}$.}
	\label{3_fig4}
\end{figure}
\par
Niech przypisy dolne wskazują na dyskretną lokalizację w przestrzeni obrazu $D$. Wtedy nielokalne operatory przedstawić można za pomocą zdyskretyzowanych równań:
\begin{equation}
{\mathrm{\nabla }}_{NLd}I_{i,j}\triangleq \left(I_j-I_i\right)\sqrt{w_{i,j}}
\label{DNLGRAD}
\end{equation}
\begin{equation}
w_{i,j}={\mathrm{exp} \left\{-\sum_{l\in G_{\sigma },j\in N_i,k\in N_j \\
}{{G_{\sigma }}_l\ast {\left|I_j-I_k\right|}^2}\right\}\ }
\label{DNLWEIGHT}
\end{equation}
\begin{equation}
{\left|\overrightarrow{p}\right|}_i\triangleq \sqrt{\sum_{j\in N_i \\ 
}{{\left(p_{i,j}\right)}^2}}
\label{DNLMAG}
\end{equation}
\begin{equation}
{\mathrm{\nabla }}_{NLd}\cdot \overrightarrow{p_i}\ \triangleq \sum_{ 
j\in N_i \\ 
}{\left(p_{i,j}-p_{j,i}\right)}\sqrt{w_{i,j}}
\label{DNLDIV}
\end{equation}
\begin{equation}
{\mathrm{\Delta }}_{NL}{\overrightarrow{p}}_i\ \triangleq \sum_{
j\in N_i \\ 
}{\left(I_j-I_i\right)}w_{i,j}
\label{DNLLAP}
\end{equation}
W szczególnym przypadku dla \eqref{NLDIVSMART} można zapisać:
\begin{equation}
{\mathrm{\nabla }}_{NLd}\cdot \overrightarrow{p_i}\ \triangleq \sum_{ 
j\in N_i \\ 
}{2p_{i,j}}\sqrt{w_{i,j}}
\label{DNLDIVSMART}
\end{equation}
Warto zauważyć, iż indeksy $i,j$ wskazują na konkretny piksel w obrazie. Lokalizacji w przestrzeni $2D$ dokonuje się przez znajomość par: $i=(x_i,y_i)$ oraz $j=(x_j,y_j)$, gdzie $x$ oś rzędnych, odpowiednio $y$ oś odciętych.
\par 
Nielokalny model wahania funkcji oznaczany $NLTV$ definiowany dla obrazów w odcieniach szarości przyjmuje następująca postać:
\begin{equation}
{\mathop{\mathrm{min}}_{u} \left\{E\left(u\right)=\ \int_D{\left|{\mathrm{\nabla }}_{NL}u(x)\right|}dx+\frac{1}{2}\int_D{{\lambda }_d{\left(u-f\right)}^2}dx\ \right\}\ }
\label{NLTVGRAY}
\end{equation}
gdzie $f$ stanowi oryginalny obraz wejściowy $f\left(x\right):D\mathrm{\longrightarrow }\mathrm{R}$, natomiast $u\left(x\right):D\mathrm{\longrightarrow }\mathrm{R}$ obraz wynikowy, będący obrazem wmalowanym, bądź w przypadku pierwotnych założeń obrazem z usuniętym szumem. W przypadku wmalowywania zmienna ${\lambda }_d$ to funkcja definiowana na podstawie maski obrazu przyjmująca następujące wartości:
\begin{equation}
{\lambda }_d\left(x\right)=\left\{ \begin{array}{c}
0\ x\ \epsilon \ \mathrm{\Omega } \\ 
1\ x\ \epsilon \ D/\mathrm{\Omega } \end{array}
\right\}
\label{maskFunction}
\end{equation}
Tak zdefiniowany model można przekształcić wykorzystując operację rozbicia Bregman’a. Rozbicie stosuje się w celu poprawienia wydajności obliczeniowej w przypadku dyskretnej implementacji problemu minimalizacji energii. Wprowadzenie pomocniczej zmiennej $\overrightarrow{v}=v\left(x,y\right):\ \mathrm{\Omega }\mathrm{\ }x\ \mathrm{\Omega }\longrightarrow R$ i parametru Bregman’a $\overrightarrow{b}=\overrightarrow{b}\left(x,y\right):\ \mathrm{\Omega }\mathrm{\ }x\ \mathrm{\Omega }\longrightarrow R$ pozwala przekształcić problem minimalizacji powyższej energii do następującej postaci iteracyjnej:
\begin{align}
\begin{aligned}
\left(u^{k+1},{\overrightarrow{v}}^{k+1}\right) &= arg\ \mathop{\mathrm{min}}_{u,\overrightarrow{v}} E\left(u,\overrightarrow{v}\right)\\ 
&= \biggl\{arg\ \mathop{\mathrm{min}}_{u,\overrightarrow{v}}
\int_D{|\overrightarrow{v}|\left(x\right)}dx+\frac{1}{2}\int_D{{\lambda }_d{\left(u-f\right)}^2}dx \\
&+  \frac{\mathrm{\Theta }}{2}\int_D{{\left|\overrightarrow{v}-{\mathrm{\nabla }}_{NL}u-{\overrightarrow{b}}^{k+1}\right|}^2(x)}dx\ \biggr\}
\end{aligned}
\label{NLTVGRAYMINPROB}
\end{align}
\begin{align}
{\overrightarrow{b}}^{k+1}={\overrightarrow{b}}^k+{\mathrm{\nabla }}_{NL}u^k-{\overrightarrow{v}}^k, {\overrightarrow{b}}^0={\overrightarrow{v}}^0=0
\label{BREGMANVARIABLE}
\end{align}
gdzie $\Theta$ stanowi uprzednio definiowany parametr algorytmu. Stosując podstawowe równanie rachunku wariacyjnego postaci równania Eulera-Lagrange’a, metodę przedstawioną w \cite{tai2011fast} oraz schemat iteracyjny Gauss’a-Seidel’a powyższe równania można sprowadzić do problemu iteracyjnego rozwiązania poniższych zależności:
\begin{align}
{\lambda }_D\left(u-f\right)+\mathrm{\Theta }{\mathrm{\nabla }}_{NL}\cdot \left({\overrightarrow{v}}^k-{\mathrm{\nabla }}_{NL}u-{\overrightarrow{b}}^{k+1}\right)=0
\label{ELNLTV1}
\end{align}
\begin{align}
{\overrightarrow{v}}^{k+1}\mathrm{=}{\mathrm{max} \left(\left|{\mathrm{\nabla }}_{NL}u^{k+1}+{\overrightarrow{v}}^{k+1}\right|-\frac{1}{\mathrm{\Theta }},0\right)\cdot\frac{{\mathrm{\nabla }}_{NL}u^{k+1}+{\overrightarrow{b}}^{k+1}}{\left|{\mathrm{\nabla }}_{NL}u^{k+1}+{\overrightarrow{b}}^{k+1}\right|}\ }
\label{ELNLTV2}
\end{align}
Zależności można stosować dla obrazów w odcieniach szarości, bądź obrazów kolorowych traktując każdą z poszczególnych warstw osobnym algorytmem iteracyjnym. Zgodnie z \cite{duan2015fast} takie rozwiązanie prowadzi do niezachowania odpowiedniego kontrastu odrestaurowanej części obrazu i niezachowania krawędzi.
\par
W celu uzależnienia od siebie wszystkich warstw obrazu autorzy w \cite{duan2015fast} proponują zastosowanie funkcjonału MTV przedstawionego w \cite{yang2009fast}, funkcjonału $CTV$ przedstawionego w \cite{blomgren1998color}, bądź model Mumford-Shah’a dokładnie opisanego w \cite{jung2011nonlocal}. Ze względu na wydajniejszą implementację oraz najlepsze wyniki uzyskiwane w przypadku modelu $CTV$ został on wybrany do badań w niniejszej pracy. Wykorzystując wspomniany funkcjonał energia przyjmuje postać:
\begin{align}
{\mathop{\mathrm{min}}_{u} \left\{E\left(u\right)=\sqrt{\sum^m_{i=1}{{\left(\int_D{\left|{\mathrm{\nabla }}_{NL}u(x)\right|}dx\right)}^2}\ }\ +\frac{1}{2}\sum^m_{i=1}{\int_D{{\lambda }_d{\left(u_i-f_i\right)}^2}dx}\ \right\}\ }
\label{ENLCTV}
\end{align}
gdzie $m$ odpowiada ilości warstw tworzących kolorowy obraz. Zastosowanie równania rachunku wariacyjnego postaci Eulera-Lagrange’a w swoim rozwiązaniu prowadzi do konieczności obliczenia nielokalnej krzywizny krzywej, będącej w przypadku dyskretyzacji rozwiązania znacznie obciążającą obliczeniowo operacją. W tym celu, podobnie jak w przypadku poprzedniego modelu $NLTV$ zastosowany zostanie heurystyczny algorytm rozbicia Bregman’a. Analogicznie wprowadzone zostają zmienne $\overrightarrow{v}=\left({\overrightarrow{v}}_1,{\overrightarrow{v}}_2,\ \dots ,\ \ {\overrightarrow{v}}_m\right)$ oraz $\overrightarrow{b}=\left({\overrightarrow{b}}_1,{\overrightarrow{b}}_2,\ \dots ,\ \ {\overrightarrow{b}}_m\right)$. Wtedy przytoczona energia przyjmuje iteracyjną postać: 
\begin{align}
\begin{aligned}
\mathop{\mathrm{min}}_{u}E\left(u\right) &= \mathop{\mathrm{min}}_{u}\Biggl\{\sqrt{\sum^m_{i=1}{{\left(\int_D{\left|\overrightarrow{v_i}\right|(x)}dx\right)}^2}\ }\\ 
&+\frac{1}{2}\sum^m_{i=1}{\int_D{{\lambda }_d{\left(u_i-f_i\right)}^2}dx} 
+\frac{\theta }{2}\sum^m_{i=1}{\int_D{{\left|\overrightarrow{v_i}-{\mathrm{\nabla }}_{NL}u_i-\ {\overrightarrow{b_i}}^{k+1}\right|}^2\left(x\right)}dx}\Biggr\}
\end{aligned}
\label{ENLCTV1}
\end{align}
\begin{align}
{\overrightarrow{b_i}}^{k+1}={\overrightarrow{b_i}}^k+{\mathrm{\nabla }}_{NL}u^k_i-{\overrightarrow{v_i}}^k,\ {{\overrightarrow{b}}_i}^0={\overrightarrow{v_i}}^0=0
\label{ENLCTV2}
\end{align}
Przyjmując naprzemienną strategię minimalizacji energii można uzyskać równania Eulera-Lagrange’a wyznaczone oddzielnie względem zmiennych $u$ oraz $v$:
\begin{align}
{\lambda }_D\left(u_i-f_i\right)+\mathrm{\Theta }{\mathrm{\nabla }}_{NL}\cdot \left({\overrightarrow{v_i}}^k-{\mathrm{\nabla }}_{NL}u_i-{{\overrightarrow{b}}_i}^{k+1}\right)=0
\label{ELNLCTV1}
\end{align}
\begin{align}
\mathrm{\Theta }\left(\overrightarrow{v_i}\mathrm{-}{\mathrm{\nabla }}_{NL}u^{k+1}_i\mathrm{-}{{\overrightarrow{b}}_i}^{k+1}\right)\mathrm{+}\frac{\int_D{\left|\overrightarrow{v_i}\right|(x)}dx}{\sqrt{\sum^m_{i=1}{{\left(\int_D{\left|\overrightarrow{v_i}\right|(x)}dx\right)}^2}\ }}\frac{\overrightarrow{v_i}}{\left|\overrightarrow{v_i}\right|(x)}\mathrm{=0}
\label{ELNLCTV2}
\end{align}
W celu przedstawienia dyskretnej formy równań \eqref{ELNLCTV1} i  \eqref{ELNLCTV2} i \eqref{ELNLCTV2} wygodnym będzie zapis dla konkretnego piksela $l\in D$ w obrazie. W przypadku \eqref{ELNLCTV1}: 
\begin{align}
{\left({\lambda }_D\right)}_l\ \ \left[{\left(u_i\right)}_l-{\left(f_i\right)}_l\right]+\mathrm{\Theta }{\mathrm{\nabla }}_{NL}\cdot \left[{\left({\overrightarrow{v_i}}^k\right)}_l-{\left({\mathrm{\nabla }}_{NL}u_i\right)}_l-{\left({{\overrightarrow{b}}_i}^{k+1}\right)}_l\right]=0
\label{DELNLCTV1}
\end{align}
Korzystając z dyskretnych form \eqref{NLGRAD}, \eqref{NLWEIGHT}, \eqref{NLPRODUCT} i \eqref{NLDIV} równanie \eqref{ELNLCTV1} można przedstawić w postaci:
\begin{align}
\begin{aligned}
{{\left(u_i\right)}_l}^{k+1} &= \frac{1}{{\left({\lambda }_D\right)}_l+2\mathrm{\Theta} \sum\limits_{j\in N_i} {\left(w_i\right)}_{l,j}\ } \Biggl[2\mathrm{\Theta }\sum_{j\in N_i} {{{\left(u^k_i\right)}_j\left(w_i\right)}_{l,j}\ }\\
&+ {\left({\lambda }_D\right)}_l{\left(f_i\right)}_l \\
&-\mathrm{\Theta} \Biggl( \sum_{j\in N_i} \left( \left({ v^k_i}\right)_{l,j} - (\left({ v^k_i}\right)_{l,j} - (\left({ v^k_i}\right)_{l,j} + (\left({ v^k_i}\right)_{l,j}\right) \sqrt{{\left(w_i\right)}_{l,j}} \Biggr]
\end{aligned}
\label{uNLCTV}
\end{align}
W przypadku równania \eqref{ELNLCTV1} Eulera-Lagrange’a należy przekształcić je względem zmiennej $\overrightarrow{v}$:
\begin{align}
\begin{aligned}
{\overrightarrow{v_i}}^{k+1} &= \mathrm{max} \left(\left|{\mathrm{\nabla }}_{NL}u^{k+1}_i+{\overrightarrow{b_i}}^{k+1}\right|-\frac{\int_D{\left|\overrightarrow{v_i}\right|(x)}dx}{\mathrm{\Theta }\sqrt{\sum^m_{i=1}{{\left(\int_D{\left|{\overrightarrow{v_i}}^k\right|(x)}dx\right)}^2}\ }},0\right) \\ 
&\cdot \frac{{\mathrm{\nabla }}_{NL}u^{k+1}_i+{{\overrightarrow{b}}_i}^{k+1}}{\left|{\mathrm{\nabla }}_{NL}u^{k+1}_i+{\overrightarrow{b_i}}^{k+1}\right|}\ 
\label{DELNLCTV2}
\end{aligned}
\end{align}
Podobnie, korzystając z dyskretnych form \eqref{NLGRAD}, \eqref{NLWEIGHT}, \eqref{FROBENIUS}, \eqref{NLPRODUCT} i \eqref{NLDIV} równanie \eqref{DELNLCTV2} można przedstawić w postaci:
\begin{align}
{\left({\overrightarrow{v_i}}^{k+1}\right)}_l\cong {\mathrm{max} \left({\left|A^{k+1}_i\right|}_l-\frac{B^k_i}{\mathrm{\Theta }\sqrt{\sum^m_{i=1}{{\left(B^k_i\right)}^2}\ }},0\right)\frac{{\left(A^{k+1}_i\right)}_l}{{\left|A^{k+1}_i\right|}_l}\ }
\label{VNLCTVITER}
\end{align}
gdzie:
\begin{align}
{\left(A^{k+1}_i\right)}_l=\left({\left(u^{k+1}_i\right)}_j-{\left(u^{k+1}_i\right)}_l\right)\sqrt{{\left(w_i\right)}_{l,j}}+{\left(b^{k+1}_i\right)}_{l,j}
\end{align} 
\begin{align}
{\left|A^{k+1}_i\right|}_l=\sqrt{\sum_j{{\left(\left({\left(u^{k+1}_i\right)}_j-{\left(u^{k+1}_i\right)}_l\right)\sqrt{{\left(w_i\right)}_{l,j}}+{\left(b^{k+1}_i\right)}_{l,j}\right)}^2}\ }
\end{align}
\begin{align}
B^k_i=\sum_l{\sqrt{\sum_j{{{\left(v^k_i\right)}^2}_{l,j}}}}
\end{align}
Warto przypomnieć, iż w przytoczonych wzorach $j$ odpowiada pikselom znajdującym się oknie poszukiwania ${\mathrm{N}}_l$ scentrowanym względem piksela $l$, a $i$ odpowiada $i$-tej warstwie spośród warstw tworzących obraz kolorowy. Autorzy w \cite{jung2011nonlocal} proponują zmodyfikowany sposób wyznaczania wagi uwzględniający kształt maski w obrazie:
\begin{align}
w\left(x,y\right)\triangleq {\mathrm{exp} \left\{-\frac{G_{\sigma }*{\chi }_R\left(x+\ \cdot \right){\left|I\left(x+\ \cdot \right)-I\left(y+\ \cdot \right)\right|}^2}{r^2}\right\}\ }
\label{NLWEIGHTMASK}
\end{align}
gdzie:
\begin{equation}
{\chi }_d\left(x\right)=\left\{ \begin{array}{c}
0\ x\ \epsilon \ \mathrm{\Omega } \\ 
1\ x\ \epsilon \ D/\mathrm{\Omega } \end{array}
\right\}
\end{equation}
Podsumowując algorytm wmalowywania w oparciu o model $NLCTV$ z algorytmem rozbicia Bregman’a można przedstawić w następujących krokach:
\begin{enumerate}
\item  
Inicjalizacja zmiennych $k=0,\ \overrightarrow{b^0_i}=0,\ \overrightarrow{v^0_i}=0,\ u^0_i=f^0_i$ 
\item  
Wyznaczenie wagi $w^2_i$ zgodnie z \eqref{NLWEIGHTMASK} dla całego obszaru obrazu $D$
\item  
Powtarzanie do spełnienia kryterium końcowego:
\begin{itemize}
%\addtolength{\itemindent}{1cm}
\item
\noindent Wyznaczenie ${\overrightarrow{b}}^{k+1}={\overrightarrow{b}}^k+{\mathrm{\nabla }}_{NL}u^k-{\overrightarrow{v}}^k$
\item
\noindent Wyznaczenie $u^{k+1}$ na podstawie \eqref{DELNLCTV1} dla każdego piksela $l$
\item
\noindent Wyznaczenie $v^{k+1}$ na podstawie \eqref{VNLCTVITER} dla każdego piksela $l$
\end{itemize}
\item  
Aktualizacja wagi $w^2_i$ w obszarze $\mathrm{\Omega }$
\end{enumerate}
Kryterium definiującym zakończenie algorytmu może być uzyskanie granicznej wartości różnicy energii $\epsilon$ uprzednio definiowanej pomiędzy wykonywanymi iteracjami:
\begin{equation}
\left|E^{k+1}-E^k\right|\le \varepsilon
\end{equation}
\section{Wariacyjny, nielokalny model wmalowywania}
Kolejną z rozważanych metod będzie metoda zaproponowana przez autorów Fedorov, Facciolo i Arias w \cite{arias2011variational}. Autorzy w publikacji proponują optymalizację energii $\mathcal{E}(\varphi(x), u(\mathcal{O}))$ zależnej od dwóch niewiadomych:
\begin{itemize}
\item
nieznanego obszaru obrazu $u(\mathcal{O})$
\item
mapy podobieństwa będącej funkcją przypisującą każdemu puntowi z nieznanego obszaru jego odpowiednika z obszaru poza maską $\varphi(\hat{x})$
\end{itemize}
\begin{figure}[!h]
	\centering
	\includegraphics[scale=0.9]{rysunki/6_fig1}
	\caption{Określenie charakterystycznych obszarów obrazu.}
	\label{6_fig1}
\end{figure}
Zgodnie z \autoref{6_fig1} niech obraz stanowi przekształcenie $ u : {\Omega} \rightarrow R$, $\mathcal{O}$ oznacza obszar do uzupełnienia, $\mathcal{O}^c$ oryginalną część obrazu nie ulegającego modyfikacji, $\mathrm{\Omega }_p$ podzbiór pikseli scentrowanych względem  piksela $p \in \Omega$, gdzie $\Omega = \mathcal{O}^c + \mathcal{O}$, $\widetilde{\mathcal{O}} := \mathcal{O} + \mathrm{\Omega }_{ps}$, gdzie $\mathrm{\Omega }_{ps}$ oznacza sumę wszystkich zbiorów punktów $x \in \mathcal{O}$. Podobnie jak w \cite{arias2011variational} niech przekształcenie $u(x)$ jest zarezerwowane dla przestrzeni maski, a $\hat{u}(\hat{x})$ odpowiada przekształceniu w przestrzeni stałej obrazu $\widetilde{\mathcal{O}}$ ( $\hat{x} \in \mathcal{O}$). Mapowanie funkcji podobieństwa $\varphi(x)$ przedstawia \autoref{6_fig2}.
\begin{figure}[!h]
	\centering
	\includegraphics[scale=0.9]{rysunki/6_fig2}
	\caption{Funkcja podobieństwa $\varphi(\hat{x})$ : $x_1 = \varphi(\hat{x_1}), x_2 = \varphi(\hat{x_2}), x_3 = \varphi(\hat{x_3})$.}
	\label{6_fig2}
\end{figure}
Energię poddawaną minimalizacji przedstawia się zależnością:
\begin{align}
\begin{aligned}
\mathcal{E}(u,\varphi) = \int_{\mathcal{\widetilde{O}}}\int_{\Omega_p}\abs{u(x+h) - \hat{u}(\varphi(x)+h)}^2dhdx
\end{aligned}
\end{align}
Funkcja jest niewypukła i pozwala obliczyć jedynie lokalne minima. W pracy wykorzystano iteracyjny algorytm przemiennej minimalizacji polegający na wyznaczaniu w każdym kroku $u(x)$ względem stałej wartości $\varphi(x)$, a następnie $\varphi(x)$ względem stałej wartości $u(x)$.
\subsection{Wyznaczenia mapy podobieństwa.}
Proces minimalizacji funkcji względem stałej zmiennej $u(x)$ można opisać zależnością:
\begin{align}
\begin{aligned}
\mathop{\operatorname{arg \ min}}_{t} \ \mathcal{E}\left( p_{u}(x) - p_{\hat{u}}(x+t)\right),\operatorname{gdzie} \ \forall_t : x+t \in \mathcal{O}^c
\label{minNNF}
\end{aligned}
\end{align}
Zmienna $t$ w minimalizacji stanowi zbiór wartości, który po dodaniu do współrzędnej $x$ mapuje do dowolnego położenia w $\mathcal{O}^c$. Wynikiem minimalizacji jest $\varphi$, która stanowi funkcję wyznaczającą najbliższego sąsiada punktu $x$ z przestrzeni $\mathcal{O}^c$, $\Theta(x) :\mathcal{O} \ \rightarrow \ \mathcal{O}^c$. Warto zaznaczyć, iż najbliższego sąsiada punktu $x$ nie rozumie się znajdującego się najbliżej, a tego dla którego zgodnie z przyjętą normą uzyskuje się najniższą wartość z pośród wszystkich możliwych:
\begin{align}
\begin{aligned}
\big\| p_{u}(x) - p_{\hat{u}}(\hat{x}) \big\| 
\label{normNNF}
\end{aligned}
\end{align}
Norma może być wyznaczana zgodnie z \eqref{NLWEIGHT} bądź \eqref{FROBENIUS}. Autorzy w \cite{MathematicalModelsforNLTextureInpainting} proponują dodatkowe definicje norm, które zostaną opisane w dalszej części pracy. Najprostszy algorytm wyznaczania najbliższego sąsiada może osiągnąć złożoność do $O(N^3)$ i stanowić duże obciążenie obliczeniowe. Autorzy w \cite{arias2011variational} proponują zastosowanie algorytmu PatchMatch dokładnie opisanego w \cite{barnes2009patchmatch}. Algorytm oparty jest na 2 krokach (punkt $x$ oznaczany będzie zamiennie ze współrzędną $(i, j)$ w obrazie):
\begin{enumerate}
\item
Losowej inicjalizacji pikseli
\item
Ograniczonej uprzednio definiowaną liczbą iteracji powtarzanej czynności:
\begin{enumerate}[a)]
\item
propagacja: w przypadku parzystej iteracji sprawdzenie wszystkich pikseli $x$ z maski w kierunku rastrowym przedstawionym na \autoref{6_fig3}, czy 
wartość $\big\| p_{u}(i,j) - p_{\hat{u}}(\varphi(i+1,j)) \big\|$, bądź $\big\| p_{u}(i,j) - p_{\hat{u}}(\varphi(i,j+1)) \big\|$ nie jest mniejsza od obecnie wyznaczonej i w takim przypadku nadpisaniu najbliższego sąsiada $\varphi(i,j) = \varphi(i+1,j)$, lub $\varphi(i,j) = \varphi(i,j+1)$, 
w przypadku nieparzystej iteracji sprawdzenie wszystkich pikseli $x$ w kierunku odwrotnym do rastrowego przedstawionym na \autoref{6_fig3}, czy 
wartość $\big\| p_{u}(i,j) - p_{\hat{u}}(\varphi(i-1,j)) \big\|$ bądź $\big\| p_{u}(i,j) - p_{\hat{u}}(\varphi(i,j-1)) \big\|$ nie jest mniejsza od obecnie wyznaczonej i w takim przypadku nadpisaniu najbliższego sąsiada $\varphi(i,j) = \varphi(i-1,j)$, lub $\varphi(i,j) = \varphi(i,j-1)$
\item
poszukiwanie w oknach: dla każdego punktu $(i,j)$ sprawdzane jest, czy w stopniowo pomniejszanych oknach centrowanych względem punktu $\varphi(i,j)$ istnieje losowy punkt $(i', j')$, dla którego zachodzi $\big\| p_{u}(i,j) - p_{\hat{u}}(i',j') \big\| < \big\| p_{u}(i,j) - p_{\hat{u}}(\varphi(i,j) \big\|$, który w następstwie jest podmieniany.
\end{enumerate}
\end{enumerate}
\begin{figure}[!h]
	\centering
	\includegraphics[scale=0.5]{rysunki/6_fig3}
	\caption{Funkcja podobieństwa $\varphi(\hat{x})$ : $x_1 = \varphi(\hat{x_1}), x_2 = \varphi(\hat{x_2}), x_3 = \varphi(\hat{x_3})$.}
	\label{6_fig3}
\end{figure}
Kroki algorytmu PatchMatch zostały przedstawione graficznie na \autoref{6_fig4}.
\begin{figure}[!h]
	\centering
	\includegraphics[scale=0.9]{rysunki/6_fig4}
	\caption{Algorytm PatchMatch. Źródło \cite{arias2011variational}.}
	\label{6_fig4}
\end{figure}
\subsection{Wyznaczenie wartości obrazu.}
Niech funkcja $e: \Omega_{p} \rightarrow {\rm I\!R}^{+}$ stanowi sumę ważonych błędów pomiędzy dwoma skrawkami obrazu scentrowanymi względem punktów $x$ i $\hat{x}$.
\begin{align}
\begin{aligned}
e(x, \hat{x}) &= g \ast \big\| p_{u}(x) - p_{\hat{u}}(\hat{u}) \big\| = g \ast \big\| u(x + \cdot) - u(\hat{x} + \cdot) \big\| \\ 
&= \int_{\Omega_{p}} g(h) \big\| u(x+h) - \hat{u}(\hat{x} +h) \big\|dh
\label{minUs}
\end{aligned}
\end{align}
gdzie zmienna $g$ jest odpowiednikiem zmiennej $G_{\sigma}$ w $NLCTV$ i opisywana jest zależnością \eqref{oknoGaussowskie}. Autorzy w \cite{arias2011variational} proponują minimalizację następującej energii będącej akumulacją błędów pikseli:
\begin{align}
\begin{aligned}
E(u) &= \int_{\widetilde O}\int_{\Omega_{p}}g(h)e(u(x+h) - \hat{u}(\varphi(x)+h)dhdx
\label{patchMatchEnergy}
\end{aligned}
\end{align} 
Niech $z := x+h$ i $\hat{z} := \hat{x}+h$. Wprowadzając zależność:
\begin{align}
m(z,\hat{z}) = \int_{\Omega_{p}}g(h)\chi_{\widetilde O}(z-h)\delta_{\varphi(z-h)}(\hat{z}-h)dh
\end{align}
gdzie:
\begin{enumerate}
\item
$\chi(p)$ podobnie jak w modelu $NLCTV$ przyjmuje wartość $1$ poza maską i wartość $0$ w masce.
\item
$\delta(p)$ określa pewność co do danego piksela wewnątrz maski i jest określone następującą zależnością:
\begin{align}
\delta(x)=(1-c_0)exp\bigg(\frac{-d(x,\partial\mathcal{O})}{t_c}\bigg) + c_0
\label{pewnoscVFI}
\end{align}
\end{enumerate}
wartość $t_c$ określa szybkość opadania funkcji ekspotencjalne, natomiast $c_0$ asymptotę, do której to funkcja zmierza. Odległość punktu od granicy maski określona jest zależnością $\frac{-d(x,\partial\mathcal{O})}{t_c}$ W zależności od zastosowanej normy \eqref{normNNF} rozwiązanie problemu minimalizacji energii uzyskuje różne postacie. Autorzy w \cite{arias2011variational} przedstawiają rozwiązanie dla następujących norm:
\begin{enumerate}
\item
Nielokalnej uśredniającej:
\begin{align}
\begin{aligned}
\big\| p_{u}(x) - p_{\hat{u}}(\hat{x}) \big\|^{2}_{g,2} = g \ast | u(x+\cdot) - \hat{u}(\hat{x}+\cdot) |^2
\label{nonLocalMeans}
\end{aligned}
\end{align}
\item
Nielokalnej medianowej:
\begin{align}
\begin{aligned}
\big\| p_{u}(x) - p_{\hat{u}}(\hat{x}) \big\|_{g,1} = g \ast | u(x+\cdot) - \hat{u}(\hat{x}+\cdot) |
\label{nonLocalMedians}
\end{aligned}
\end{align}
\item
Nielokalnej Poissona:
\begin{align}
\begin{aligned}
\big\| p_{u}(x) - p_{\hat{u}}(\hat{x}) \big\|_{P} &= \big\| p_{u}(x) - p_{\hat{u}}(\hat{x}) \big\|^{2}_{g,2} + \big\| p_{u}(x) - p_{\hat{u}}(\hat{x}) \big\|^{2}_{g,2,\nabla} \\
&= g \ast (\lambda | u(x+\cdot) - \hat{u}(\hat{x}+\cdot) | \\
&+ (1-\lambda)|\nabla u(x+\cdot) - \nabla \hat{u}(\hat{x}+\cdot)|
\label{nonLocalpoisson}
\end{aligned}
\end{align}
\end{enumerate}
Suma różnic pikseli w przypadku normy Poissona dodatkowo wymaga wyznaczenia dywergencji obrazu. Współczynnik $\lambda$ określa w jakim stopniu poszczególny z członów będzie miał wpływ na ostatecznie uzyskiwany wynik. Dla norm uzyskuje się odpowiednio rozwiązania w postaci:
\begin{enumerate}
\item
równanie:
\begin{align}
u(z) = \frac{1}{k(z)}\int_{\widetilde O^c}m(z,\hat{z})\hat{u}(\hat{z})d\hat{z}
\end{align}
gdzie
\begin{align}
k(z) := \int_{\widetilde O^c}m(z,\hat{z})d\hat{z}
\end{align}
\item
równanie Eulera:
\begin{align}
[\delta_{u}\mathcal{E}(u)](z) = \int_{\mathcal{O}^c}sign[u(z)-\hat{u}(\hat{z})]m(z,\hat{z})d\hat{z} \ni \mathcal{O} 
\end{align}
\item
równania Eulera rozwiązane względem zmiennej $u$:
\begin{align}
\begin{aligned}
\begin{cases}
\nabla \cdot [k(z)\nabla u(z)] - \frac{\lambda}{1-\lambda}]k(z)u(z) = \\ 
\ \ \nabla \cdot [k(z)\nabla v(z)] - \frac{\lambda}{1-\lambda}]k(z)f(z) , & z \in \mathcal{O} \\
u(z)=\hat{u}(z) , & z \in \partial \mathcal{O} \setminus \partial \Omega \\
\nabla u(z) \cdot n_{\Omega}(z) = 0 , & z \in \partial \mathcal{O} \cap \partial \Omega
\end{cases}
\end{aligned}
\end{align}
gdzie:
\begin{align}
v(z) := \frac{1}{k(z)}\int_{O^c}m(z,\hat{z})\nabla\hat{u}(\hat{z})d\hat{z}
\end{align}
\begin{align}
f(z) := \frac{1}{k(z)}\int_{O^c}m(z,\hat{z})\hat{u}(\hat{z})d\hat{z}
\end{align}
Człon $n_{\Omega}(z)$ oznacza wektor normalny do $\Omega$ dla $z \in \partial \Omega$.
\end{enumerate}
Dokładne wyprowadzenia zależności można znaleść w \cite{arias2011variational}.
\subsection{Wielostopniowy schemat wypełniania.}
W wielu algorytmach wypełniania braków w obrazie stosowany jest algorytm wielostopniowy, przykładem mogą być \cite{kawai2009image}, \cite{komodakis2007image} bądź \cite{wexler2007space}. Algorytm polega na utworzeniu serii pomniejszych przeskalowanych obrazów, następnie wypełnianiu ich począwszy od najmniejszego z warunkami początkowymi uzyskanymi poprzez przeskalowanie do większego obrazu uprzednio wyznaczonych wartości w masce. W przypadku najmniejszego obrazu z serii warunkami początkowymi mogą być:
\begin{itemize}
\item
losowo wyznaczone wartości obrazu pobierane z obszaru $\mathcal{O}^c$
\item
rozwiązanie równania Poisson'a \eqref{Poisson2D}, dokładnie przedstawione w \autoref{chap:navierstokes}, metodą SOR zgodnie z zależnością \eqref{DiscreteSOR}.
\end{itemize}
Przeskalowywanie w obie strony musi odbywać się w sposób nie zniekształcający głównych struktur, obiektów i tekstur obrazu. W tym celu autorzy w \cite{arias2011variational} proponują model Gauss'owskiej piramidy.\\
W celach wmalowywania tworzone są dwie oddzielne piramidy wyznaczające maski obrazu i same obrazy. Niech $S$ oznacza liczbę stopni piramidy, a oryginalny wymiar jest oznaczany przez $s=0$. Niech rozmiar najmniejszego stopnia określa $A_{s-1}$, natomiast rozmiar oryginalnego obrazu $A_{0}$. Wtedy współczynnik próbkowania do tworzenia coraz mniejszych obrazów wynosi:
\begin{align}
r := \left(\frac{A_0}{A_{s-1}}\right)^\frac{1}{s-1}
\end{align}
W rezultacie aby uzyskać mniejszy obraz musi zachodzić $r \geq 1$. Parametr $\sigma$ tworzonego filtru Gauss'a wyznaczany jest z zależności $\sigma(r)=0.62\sqrt[2]{r^2-1}$. Jako rozmiar okna Gauss'a wykorzystywanego do filtrowania można przyjąć jako stały uprzednio definiowany. Niech indeks górny s odnosi się do zmiennych i obszarów w zakresie rozważanego stopnia piramidy. W przypadku tworzenia kolejnych masek wykorzystywane jest próbkowanie w dół z ograniczeniem w postaci zależności między funkcjami charakterystycznymi wmalowywanych obszarów $\mathcal{O}^s$ i $\mathcal{O}^{s+1}$:
\begin{align}
\chi_{\mathcal{O}^{s+1}}=(\downarrow_rg_{\sigma(r)}\ast\chi_{\mathcal{O}^s})> T_{0}.
\end{align}
Autorzy w \cite{arias2011variational} proponują wartość $T_0=0.4$. Niech $f$ stanowi wynik próbkowania w dół z filtrem Gauss'a. Zapis oznacza, iż w przypadku gdy $f(x)>0.4$ punkt w przekształceniu traktowany jest jako punkt źródłowy obrazu nie wymagający wmalowania. W przypadku obrazu wykorzystywana jest zależność
\begin{align}
u^{s+1}(x)= \downarrow_r \frac{g \ast \chi_{(O^s)^c} u^s(x)}{g \ast \chi_{(O^s)^c}(x) }
\end{align}
Powyższe równanie przedstawia ograniczenie w postaci nieuwzględniania wartości znajdujących się w obszarze $\mathcal{O}^c$. Obraz w pierwszym kroku zostaje przemnożony przez maskę przedstawiającą źródłową część obrazu, następnie dokonywana jest operacja splotu obrazu z utworzonym filtrem Gauss'a normalizowany członem $g \ast \chi_{(O^s)^c}(x)$. W przypadku próbkowania do góry, wyznaczane są dwie piramidy: obraz w ograniczeniu do obszaru wmalowanego w poprzednim stopniu oraz pomocnicza funkcja przedstawiająca mapę podobieństwa. Do tego został wykorzystany algorytm dokładnie przedstawiony w \cite{wexler2007space} i opisany w \cite{arias2011variational}.
\subsection{Podsumowanie algorytmu}
Łącząc opisane powyżej operacje dokonywane na obrazie algorytm wypełniania można przedstawić w następujących krokach:
\begin{enumerate}
\item
Ustawienie argumentów algorytmu: obraz $u^{0}$, maska obrazu $\chi$, liczba poziomów piramidy $S$, rozmiar najmniejszego obrazu $A_{S-1}$, ilość iteracji minimalizacji energii $I$
\item
Wyznaczenie piramidy maski stanowiącej zbiór: $\{\chi^s\}_{s=0,...,S-1}$ \\
Wyznaczenie piramidy obrazu stanowiącej zbiór: $\{u^s\}_{s=0,...,S-1}$
\item
Inicjalizacja obrazu $u^{S-1}$ w obszarze $\mathcal{O}$ \\
Wyznaczenie mapy podobieństwa $\varphi^{S-1}$ na podstawie $u^{S-1}$
\item
Wykonanie dla każdego z poziomów piramidy $s$ począwszy od $S-2$ do $0$:
\begin{enumerate}[a)]
\item
Przeskalowanie mapy podobieństwa z zastosowaniem algorytmu interpolacji najbliższego sąsiada $\varphi^s=r \cdot (\uparrow_r \varphi^{s+1})$
\item
Wyznaczenie przeskalowanego obrazu $u^s_0=r \cdot (\uparrow_r u^{s+1})$ i przepisanie wartości $u^s(\mathcal{O})=u^s_0(\mathcal{O})$ w celu inicjalizacji
\item
Powtarzanie $I$-tą ilość razy z wykorzystaniem odpowiedniej normy \eqref{normNNF}
\begin{itemize}
\item
minimalizacja \eqref{minNNF} w celu wyznaczenia $\varphi^s$
\item
minimalizacja \eqref{minUs} w celu wyznaczenia $u^s$
\end{itemize}  
\end{enumerate}
\end{enumerate}
Wynikiem powyższej instrukcji jest zbiór obrazów $\{u^s\}$ oraz map podobieństwa $\{\varphi^s\}$, gdzie $s \in {0,...,S-1}$
\chapter{Uzupełnianie kawałkami obrazu.}
\section{Metoda Criminisi.}
Kolejną grupą algorytmów rozważanych w niniejszej pracy jest grupa opierająca się na wypełnianiu brakujących obszarów w obrazie skrawkami pochodzącymi z ich otoczenia. W odróżnieniu od metod bazujących na równaniach różniczkowych metoda uzupełniania braków nie bazuje na metodzie dyfuzji. Pierwszy raz zaproponowana została w \cite{efros1999texture}, a jej podstawowy krok opiera się na schemacie przedstawionym na poniższym rysunku.
\begin{figure}[!h]
	\centering
	\includegraphics[scale=0.5]{rysunki/4_fig1}
	\caption{Schemat wmalowywania obrazu.}
	\label{4_fig1}
\end{figure}
Zgodnie z \autoref{4_fig1} niech zbiór $D$ oznaczony kolorem jasnozielonym określa znane punkty obrazu, natomiast $\omega $ oznaczony kolorem fioletowym określa obszar do odrestaurowania. Niech obraz wejściowy stanowi funkcję $\mathrm{\Omega }$. Niech ${\varphi}_p$ stanowi podzbiór punktów tworzących skrawek o uprzednio zdefiniowanej wielkości, scentrowany względem piksela $p$ znajdującego się na granicy maski $\partial \mathrm{\Omega }$. Niech ${\varphi}_q$ stanowi podzbiór punktów tworzących skrawek o rozmiarze równym rozmiarowi ${\varphi}_p$, scentrowany względem piksela $q$ dla którego żaden z punktów wyznaczonego skrawka nie znajduje się w obszarze maski. Niech ${\varphi}_{p'}$ oznaczone kolorem żółtym stanowi podzbiór punktów znajdujących się w ${\varphi}_p$, które nie znajdują się w obrębie maski. Wtedy ${\varphi}_{q'}$ oznaczone kolorem pomarańczowym stanowi grupę pikseli zlokalizowanych odpowiednio według pikseli z podzbioru ${\varphi}_{p'}$. Zgodnie z nomenklaturą matematyczną:
\begin{align}
p\ \epsilon \ \partial \mathrm{\Omega }
\end{align}
\begin{align}
q\ \epsilon \mathrm{\ }\phi
\label{qSource}
\end{align}
\begin{align}
\phi \ \subset \ D
\end{align}
\begin{align}
{\varphi }_p=\mathrm{(p+\ }\mathrm{\cdot }\mathrm{)}
\end{align}
\begin{align}
{\varphi }_q=(q+\ \cdot )\ 
\end{align}
\begin{align}
{\varphi }_{p'}=\ {\varphi }_p\cap (D\cup W) 
\end{align}
\begin{align}
{\varphi }_{q'}\ \subset \ {\varphi }_q
\end{align}
gdzie $W$ przedstawia zbiór wmalowanych pikseli uprzednio znajdujących się w rejonie maski.
\par
Podstawową operacją wmalowywania metodą propagacji tekstury obrazu jest znalezienie najpodobniejszej pary $\left\langle {\ \varphi }_{p'},\ {\varphi }_{q''}\right\rangle $ oraz zgodnie z powyższym rysunkiem przepisanie wartości odpowiednich pikseli z wyznaczonego zbioru $({\varphi }_{(q^{''})}/{\varphi }_{(q^{''})'})$ do odpowiadających im pikseli w zbiorze $({\varphi }_p/{\varphi }_{p'})$ oznaczonych kolorem ciemnozielonym. Zapisując matematycznie:
\begin{align}
{\varphi }_{q^{''}}={\mathrm{arg}\ \mathop{\mathrm{min}}_{q\ \epsilon \mathrm{\ }\phi } d(\ }{\varphi }_{p'},{\varphi }_{q'})
\label{FROBDIST}
\end{align}
Dystans pomiędzy dwoma skrawkami $d({\varphi }_{p'},{\varphi }_{q'})$ może być definiowany jako suma kwadratów różnic wszystkich odpowiadających sobie pikseli ${\varphi }_{p'}$ oraz ${\varphi }_{q'}$.
\begin{align}
d(\varphi_{p'},\varphi_{q'})= \sum_{p\in \varphi_{p'}} \left( \varphi_{p^{'}}(p) - \varphi _{q^{'}} \left(p^{'}\right) \right)^2
\label{FROBENIUS2} 
\end{align}
gdzie $\varphi \left(p\right)$ wartość jasności piksela $p$ z badanego okna. Do wyznaczenia dystansu można również zastosować normy przytoczone dla \eqref{normNNF} w \cite{MathematicalModelsforNLTextureInpainting}. W celu odrestaurowania obrazu powyższy schemat powtarzany jest aż do momentu wypełnienia całego obszaru $\mathrm{\Omega }$.
Metoda wmalowywania pierwszy raz przedstawiona w  \cite{efros1999texture} nie zakłada żadnego priorytetu ani kolejności wypełniania braków ustalanej na podstawie otoczenia maski. Przeprowadzana synteza obrazu pomimo wyznaczenia dla danego piksela trafnego dopasowania może prowadzić do akumulowanej przez algorytm niespójności obrazu.
\begin{figure}[!h]
	\centering
	\includegraphics[scale=1]{rysunki/4_fig2}
	\caption{Wpływ prostego schematu wypełniania braków na wynikową teksturę obrazu. Źródło \cite{criminisi2004region}.}
	\label{4_fig2} 
\end{figure}
\par
W 2004 roku Criminisi w \cite{criminisi2004region} korzysta z koncepcji próbkowania kawałków obrazu proponując nowe podejście do wyznaczania kolejności ich wmalowywania.  Kolejność wypełniania wyznaczana jest na podstawie izolinii poziomu jasności obrazu. W każdej iteracji algorytmu dla pikseli sąsiadujących z maską wyznaczane są wartości priorytetu. Następnie wypełnienie odbywa się dla piksela o największym priorytecie. Dzięki nowemu podejściu izolinie będące granicami struktur obrazu są kontynuowane w miejsca odrestaurowywane.
\par
Algorytm przedstawiony w \cite{criminisi2004region} opiera się na powtarzaniu 3 głównych kroków w każdej iteracji wykonywanej do momentu wypełnienia wszystkich pikseli ze zbioru $\mathrm{\Omega }$. Każda kolejna iteracja prowadzi do przesunięcia granicy maski w jej głąb. W trakcie próbkowania kawałków obrazu zbiór $\phi $ będący źródłem próbkowania nie zmienia się. Pierwsze dwa kroki w pojedynczej iteracji służą wyznaczeniu priorytetu $P\left(p\right)$ dla każdego piksela obrazu znajdującego się na granicy maski $\partial \mathrm{\Omega }$, natomiast trzeci znalezieniu najlepszego dopasowania ${\varphi }_{q^{''}}$. Priorytet $P\left(p\right)$ każdego piksela $p$ znajdującego się na granicy maski wyznaczany jest z zależności:
\begin{align}
P\left(p\right)=Ct(p)\cdot Dt(p)
\label{PRIORITY}
\end{align}
Pierwszy krok w każdej wykonywanej iteracji związany jest z obliczenie wartości funkcji $Ct(p)$ definiowanej:
\begin{align}
Ct\left(p\right)=\ \frac{\sum_{q\in {\varphi }_{p'}}{C(q)}}{\left|{\varphi }_p\right|}
\label{confidenceTerm}
\end{align}
gdzie $C(q)$ - funkcja przypisująca wszystkim pikselom z obrazu poziom wiarygodności odwzorowania oryginalnego obrazu, $\left|{\varphi }_p\right|$ - liczba pikseli w analizowanym kawałku - rozmiar rozważanego okna. 
\par
Podczas inicjalizacji funkcja $C(q)$ dla każdego piksela stanowiącego oryginalny obraz przyjmuje wartość $1$, natomiast dla punktów maski przyjmuje 0. Matematycznie ${\forall }_{q\in D}\ C\left(q\right)=1$  i analogicznie ${\forall }_{q\in \mathrm{\Omega }}\ C\left(q\right)=0$. Wraz z wyznaczaniem kolejnych wartości pikseli z rejonu maski funkcja $C\left(q\right)$ jest aktualizowana, a zerowe wartości są nadpisywane. Funkcja $Ct\left(p\right)$ jest sumą wartości $C\left(p\right)\ $wszystkich pikseli z analizowanego skrawka scentrowanego względem piksela p, które znajdują się w przestrzeni wyznaczonego już obrazu podzielonej przez ilość pikseli w danym skrawku. Funkcję interpretuje się jako czynnik wymuszający koncentryczne, czyli postępujące wypełnianie wzdłuż granicy maski nieznanych punktów zgodnie z pierwotnym założeniem w \cite{efros1999texture}. Wynika to z pierwszeństwa jakie wprowadza funkcja $C\left(p\right)$ przypisując w każdej iteracji coraz niższe wartości kolejnym wypełnianym pikselom. W ten sposób pierwszeństwo wypełniania uzyskują wycinki obrazu zawierające większą liczbę pikseli wypełnionych w poprzednich iteracjach, bądź zawierających oryginalne części obrazu. Mniejsza wartość $C\left(p\right)$ w każdym kroku interpretuje się jako mniejszą pewność co do przepisanych wartości koloru w obrazie. Zmienna $C(q)$ można opisać wykorzystując przytoczoną już zależność \eqref{pewnoscVFI}.
Drugi krok w każdej wykonywanej iteracji związany jest z obliczenie wartości funkcji $D(p)$ definiowanej jako:
\begin{align}
D(p)=\ \frac{\left|{\mathrm{\nabla }}^{\bot }I_P\cdot n_p\right|}{\alpha }
\label{DataTerm}
\end{align}
gdzie człon ${\mathrm{\nabla }}^{\bot }I_P$ podobnie jak w przypadku równania Naviera-Stokes'a odpowiada kierunkowi rozchodzenia się izolinii obrazu, natomiast  $n_p$ to wektor normalny (prostopadły) do granicy maski $\partial \mathrm{\Omega }$ w punkcie piksela $p$.  
\begin{figure}[!h]
	\centering
	\includegraphics[scale=1]{rysunki/4_fig3}
	\caption{Oznaczenie wektorów wykorzystywanych do liczenia wartości $\boldsymbol{D}\left(\boldsymbol{p}\right)$.}
	\label{4_fig3} 
\end{figure}
Zgodnie z \autoref{4_fig3} funkcja $D\left(p\right)$ w sposób liczbowy określa z jaką siłą izolinia obrazu uderza granicę maski. Ta zalebna jest od gradientu jasności obrazu ${\mathrm{\nabla }}^{\bot }I_P$ oraz orientacji względem gradientu wektora normalnego do granicy maski. Funkcja przyjmuje największą wartość w momencie, w którym wektor normalny oraz wektor izolinii są do siebie równoległe (zgodnie z iloczynem skalarnym wektorów ${\mathrm{cos} 0^0\ }=1)$, a człon ${\mathrm{\nabla }}^{\bot }I_P$ ma największą wartość. W przeciwieństwie do definicji terminu $Ct(p)$ funkcję $D(p)$ można zinterpretować jako człon odpowiedzialny za przyznanie wyższego priorytetu pikselowi, stanowiącemu część struktury, która według psychologii widzenia powinna być kontynuowana w głąb odrestaurowywanego obszaru. Funkcja $D(p)$ wpływa ma zmniejszenie pojawiającego się w metodzie zjawiska wprowadzania niespójności obrazu. Niech funkcja $M$ w punktach oryginalnego obrazu $D$ przyjmuje wartość 0 oraz w punktach maski w punktach $\mathrm{\Omega }$ wartość 1, $I:D\to \{0,1\}$.  Wtedy korzystając z zależności \eqref{dfdx} i \eqref{dfdy} wektor normalny do granicy maski można wyznaczyć z zależności:
\begin{align}
n_p=\ \ \left[-n_x\frac{1}{L}\ ,\ -n_y\frac{1}{L}\right]\ =\ \left[-\frac{M_{i+1,j}+M_{i-1,j}}{2h}\cdot \frac{1}{L}\ ,\ -\frac{M_{i,j+1}+M_{i,j-1}}{2h}\cdot \frac{1}{L}\right]
\label{KIERUNEK}
\end{align}
\begin{align}
L=\ \sqrt{n^2_x+\ n^2_y}
\label{POMKIERUNEK}
\end{align}
Postać dyskretna równania \eqref{DataTerm} zgodnie z \eqref{u}, \eqref{v}, \eqref{KIERUNEK} i \eqref{POMKIERUNEK} przyjmuje postać:
\begin{align}
D(p)=\ \left|u{\cdot n}_x\frac{1}{L}-v\cdot n_y\frac{1}{L}\right|
\end{align}
Znając wartości $Ct\left(p\right)$ oraz $D(p)$ dla każdego piksela z granicy maski można wyznaczyć wartość priorytetów $P(p)$. Na ich podstawie wybierane jest okno ${\varphi }_p$, a następnie najlepsze odwzorowanie ${\varphi }_{q^{''}}$. Ze względu na nieregularny kształt większości masek wyznaczenie jej granicy $\partial \mathrm{\Omega }$ można wykonać poprzez operację erozji i dylacji na funkcji $M$. Innym sposobem może być zastosowanie dyskretnego splotu maski $M$ z macierzą $mL\ $reprezentującą Laplasjan dla siatki 8-spójnej: 
\begin{equation}
mL=\left| \begin{array}{ccc}
1 & 1 & 1 \\ 
1 & -8 & 1 \\ 
1 & 1 & 1 \end{array}
\right|	
\label{LAPLASJAN}
\end{equation}
Podsumowując operację wmalowywania obrazu można przedstawić następującym algorytmem. Powtarzać aż do wypełnienia wszystkich pikseli z $\mathrm{\Omega }$:
\begin{enumerate}
\item
Na podstawie \eqref{LAPLASJAN} wyznaczyć granicę maski $\mathrm{\partial }\mathrm{\Omega }$
\item
Na podstawie \eqref{PRIORITY} wyznaczyć priorytety wszystkich pikseli z granicy maski $\mathrm{\partial }\mathrm{\Omega }$
\item
Na podstawie \eqref{FROBENIUS} wyznaczyć najlepsze dopasowanie dla okna utworzonego na podstawie punktu 2 
\item
Zgodnie z \autoref{4_fig1} przepisać wartości z okna najlepszego dopasowania w odrestaurowywany obszar, jednocześnie aktualizując wartości $C(p)$ zgodnie z zależnością:
\begin{align}
C\left(p\right)=C\left(\dot{p}\right)
\end{align} 
gdzie $p\in \ {\varphi }_p\cap \ \mathrm{\Omega }$, a $C\left(\dot{p}\right)$ to deprecjonowana wartość w każdej kolejnej iteracji.
\end{enumerate}
\section{Pojęcie głównych struktur.}
Poprawa algorytmu przedstawiona w \cite{criminisi2004region} prowadzi do polepszenia otrzymywanych wyników, lecz nie w optymalnym stopniu. W celu dalszej minimalizacji uzyskiwanych niespójności w obrazie i optymalizacji pod kątem szybkości działania algorytmów zostały wprowadzone kolejne modyfikacje: \cite{StructurePropagationManual},  \cite{malluvalasaimplementation}, \cite{SalientStrucTexProp}. 
Jednym z istotnych ulepszeń algorytmu wmalowywania w oparciu o kopiowanie kawałków jest wprowadzenie zależności kolejności ich wstawiania w oparciu o główne struktury w obrazie. W niniejszej pracy zaimplementowano i sprawdzono odrestaurowywanie obrazu na podstawie zadawanych ręcznie przez użytkownika głównych linii zgodnie z \cite{StructurePropagationManual}. Różnica pomiędzy zwykłym algorytmem przedstawionym w \cite{criminisi2004region}, a nowym rozwiązaniem polega na wstępnej definicji przez użytkownika grupy punktów znajdujących się w masce. Najczęściej są to krzywe, które zgodnie z psychologią widzenia powinny być kontynuowane w głąb maski tworząc odpowiednie połączenia między sobą. Krzywe charakteryzują się ograniczoną grupą pikseli mogących stanowić źródło uzupełniania maski. Ograniczając pole $\phi $ dla każdej kontynuowanej znacznie przyspiesza się krok iteracji związany z odnalezieniem najlepszej pary dopasowania ${\varphi }_{p'}$ oraz ${\varphi }_{q'}$. Schemat wmalowywania w oparciu o powyższy algorytm przedstawia poniższy rysunek.
\begin{figure}[!h]
	\centering
	\includegraphics[scale=0.8]{rysunki/4_fig4}
	\caption{Koncepcja wmalowywania w oparciu o główne struktury obrazu. Źródło \cite{StructurePropagationManual}}
	\label{4_fig4} 
\end{figure}
\section{Automatyczne wykrywanie struktur.}
W celu zaprojektowania w pełni automatycznego programu do procesu wmalowywania opierającego się na algorytmie wprowadzonym przez Criminisi zaproponowano dodatkową analizę obrazu ograniczającą interakcję użytkownika wyłącznie do wprowadzenia maski. Autorzy w \cite{SalientStrucTexProp} proponują wykonać 2 dodatkowe kroki:
\begin{enumerate}
\item
Wyznaczenie głównych struktur obrazu.
\item
Rozwiązanie poniższych zależności:
\begin{align}
D(i,j)\triangleq IP\cdot \left[\alpha \cdot D_1\left(f^i_C,f^j_C\right)\ +\ \beta {\cdot D}_2\left(f^i_T,f^j_T\right)+\gamma {\cdot D}_3\left(f^i_{Cur},f^j_{Cur}\right)\right]
\label{SalientDistance}
\end{align}
\begin{align}
Paired\left(i,j\right)={\mathrm{arg}\ \mathop{\mathrm{min}}_{i,j\ \epsilon \mathrm{\ }\{1,..,N\}} D(i,j)\ }
\label{SalientPair}
\end{align}
\end{enumerate}
Analiza powyższych równań wykonana zostanie w szczegółowy sposób dla każdego z członów $\alpha \cdot D_1\left(f^i_C,f^j_C\right)\ $,$\ \beta {\cdot D}_2\left(f^i_T,f^j_T\right)$, oraz $\gamma {\cdot D}_3\left(f^i_{Cur},f^j_{Cur}\right)$. Uprzednim krokiem do powyższych równań według \cite{SalientStrucTexProp} jest wyznaczenie głównych struktur na podstawie obrazu wejściowego poddanemu wstępnemu rozmyciu funkcją Gaussa:
\begin{align}
G\left(x,y\right)=\frac{1}{\sqrt{2\pi }\sigma }e^{\frac{x^2+y^2}{2{\sigma }^2}}
\label{rozmycieGaussa}
\end{align}
Operacji rozmycia dokonuje się poprzez operację splotu obrazu z odpowiednio wygenerowaną macierzą wyznaczoną na podstawie powyższego równania. Operacja rozmycia pozwala pozbyć się mniej znaczących krawędzi z obrazu zostawiając tylko najistotniejsze cechy, które powinny być kontynuowane w niewyznaczony obszar. Po operacji rozmycia autorzy w \cite{SalientStrucTexProp} proponują wykrycie głównych struktur na podstawie transformacji falkowej oraz odpowiednio wyznaczonych lokalnych maksimów dla funkcji powstałych na podstawie wspomnianej transformacji. Na podstawie przeprowadzonej operacji uzyskuje się wszystkie główne struktury obrazu. Zbiorem krawędzi poddanych do analizy są ostatecznie struktury, dla których dochodzi do przecięcia ze zdefiniowaną maską $\mathrm{\Omega }$ zgodnie z poniższym rysunkiem (jako maska traktowany jest samochód).
\begin{figure}[!h]
	\centering
	\includegraphics[scale=0.8]{rysunki/4_fig5}
	\caption{Koncepcja wmalowywania w oparciu o główne struktury obrazu. źródło \cite{StructurePropagationManual}.}
	\label{4_fig5} 
\end{figure}
Dla każdej linii stykającej się z obszarem $\mathrm{\Omega }$ wyznaczony zostaje punkt środkowy. Względem środka tego punktu tworzone jest okno  $f^i$ o uprzednio zdefiniowanym obszarze. Pierwszym członem w równaniu [4.19][4.19] wyznaczonym na podstawie utworzonego okna $f^i$ jest $D_1\left(f^i_C,f^j_C\right)$. Symbole $f^i_C$ oraz $f^j_C$ stanowią posegmentowane fragmenty obrazu względem uprzednio zdefiniowanej liczby głównych, dominujących kolorów w obrazie $M$. Dla każdego wycinka $f^i_C$ można zdefiniować zbiór punktów $(c_k,p_k)$, gdzie $c_k$ odpowiada danemu kolorowi, $p_k$ jego procentowemu udziałowi we fragmencie $f^i$, gdzie $k=1,\dots ,M$. Dysponując zbiorami punktów dla okien $f^i_C$,$\ f^j_C$ można liczbowo przedstawić ich poziom podobieństwa obliczając: 
\begin{align}
D_1\left(f^i_C,f^j_C\right)=IOCCD({\left(c_k,p_k\right)}_i,{\left(c_k,p_k\right)}_j
\end{align}
Dokładna analiza oraz sposób wyznaczania podobieństwa okien $f^i$ przedstawiony jest w \cite{chen2005adaptive}. 
 Drugim członem w równaniu [4.19][4.19] jest $D_2\left(f^i_T,f^j_T\right)$ określający stopień podobieństwa tekstur znajdujących się w utworzonych oknach $f$. Dla każdego obszaru $f^i$ z wyznaczonego zbioru okien wyznaczana jest macierz $MR8(f^i)$. Macierz uzyskiwana jest ma podstawie odpowiedzi fragmentu obrazu na grupę 38 filtrów przedstawionych na poniższym rysunku.
\begin{figure}[!h]
	\centering
	\includegraphics[scale=1]{rysunki/4_fig6}
	\caption{Bank 38 filtrów grupy MR8. źródło \cite{varma2009statistical}.}
\label{4_fig6}
\end{figure}
Przez odpowiedź obrazu na filtr należy rozumieć operację splotu z macierzą odpowiadającą definicji konkretnego filtru. W grupie filtrów $MR8$ branych pod uwagę znajduje się filtr Gaussowski, oraz filtr $LOG$ będący laplasjanem funkcji gaussowskiej. Na pozostałe 36 filtrów składają się dwie grupy filtrów utworzonych na podstawie filtru krawędziowego oraz filtru prętowego. Każdy z nich przedstawiony jest w sześciu orientacjach oraz 3 skalach zgodnie z rysunkiem \autoref{4_fig6}. Jako maksymalną odpowiedź na bazę trzydziestu ośmiu filtrów rozumie się zależność:
\begin{align}
I_{fmax}(p)=\mathrm{max}\mathrm{}(I_{f1}(p),I_{f2}(p),\dots ,I_{f38}(p))
\end{align}
gdzie $p$ - piksel obrazu poddanego filtracji, $p\in I$, $I_{fi}$ - odpowiedź obrazu $I$ na $i$-ty filtr z bazy filtrów. Podobieństwo wyznaczonych okien odpowiadających głównym strukturom w obrazie można wyrazić zależnością:
\begin{align}
D_2{\left(f^i_T,f^j_T\right)}_i=\frac{{\left|MR8\left(f^i\right)-MR8\left(f^j\right)\right|}_F}{250}=\frac{{\left|f^i_T-f^j_T\right|}_F}{250}
\end{align}
W powyższej zależności norma oznaczona literą $F$ odpowiada normie Frobenius'a liczonej następująco:
\begin{align}
\left|I\right|=\ \sqrt{\sum_{p\in I}{{\left|I\left(p\right)\right|}^2}}=\sqrt{{\sum^m_{i=1}{\sum^n_{j=1}{\left(f^i_T(i,j)-f^j_T(i,j)\right)}}}^2}
\end{align}
Dokładny algorytm klasyfikacji tekstur przedstawiony został przez Manika Varma'e i Adrew Zisserman'a w \cite{varma2009statistical}. Ostatnim członem w równaniu \eqref{SalientDistance} jest człon $D_3\left(f^i_{cur},f^j_{cur}\right)$ odpowiadający liczbowej reprezentacji podobieństwa krzywizn ze zbioru głównych struktur. Autorzy w \cite{SalientStrucTexProp} nie podają sposobu wyznaczenia normy:
\begin{align}
D_3\left(f^i_{cur},f^j_{cur}\right)=\ \left|curvature_i-curvature_j\right|
\end{align}
Proponują natomiast każdą z wyznaczonych głównych struktur przedstawić w postaci równania wielomianu drugiego stopnia. Aproksymacji współczynników wielomianu można dokonać na podstawie rozwiązania poniższego równania macierzowego:
\begin{align}
\left| \begin{array}{ccc}
n & \sum{x_i} & \sum{x^2_i} \\ 
\sum{x_i} & \sum{x^2_i} & \sum{x^3_i} \\ 
\sum{x^2_i} & \sum{x^3_i} & \sum{x^4_i} \end{array}
\right|\cdot \left| \begin{array}{c}
a_0 \\ 
a_1 \\ 
a_2 \end{array}
\right|=\left| \begin{array}{c}
\sum{y_i} \\ 
\sum{x_iy_i} \\ 
\sum{{x^2_iy}_i} \end{array}
\right|
\end{align}
gdzie $n$ określa liczbę zastosowanych par $(x_i,y_i)$, a wielomian przedstawia się w postaci:
\begin{align}
curvature_i={f_i\left(x\right)=a}_{0_i}+a_{1_i}x+a_{2_i}x^2
\end{align}
Według wyznaczonych równań, pary głównych struktur uzyskane w dalszych krokach algorytmu, propagowane są w głąb przestrzeni $\mathrm{\Omega }$, aż do momentu ich przecięcia. Ostatnią ważną zmienną w równaniu \eqref{SalientDistance} jest $IP$. Jest to zmienna, która przyjmuje wartość zerową, gdy badana para głównych struktur nie jest ze sobą równoległa, bądź jeden w przeciwnym wypadku. Aby uzyskać równania prostych opisujące wyznaczone krzywe można dokonać aproksymacji na podstawie transformacji Hough'a. Transformacja bazuje na wygodnej postaci równania prostej:
\begin{align}
y=\ -\frac{{\mathrm{cos} \theta \ }}{{\mathrm{sin} \theta \ }}x+\frac{r}{{\mathrm{sin} \theta \ }}
\label{HOUGHTRANSFORM}
\end{align}
Posługiwanie się parametrami $\theta $ oraz $r$ pozwala uniknąć niejednoznaczności, w przypadku opisu pionowych linii oraz umożliwia przedstawienie prostej w postaci jednego punktu w przestrzeni Hough'a. Mapowanie z przestrzeni $D$ można przedstawić następująco:
\begin{figure}[!h]
	\centering
	\includegraphics[scale=1]{rysunki/4_fig7}
	\caption{Odwzorowanie prostej w przestrzeni Hough’a}
\label{4_fig7}
\end{figure}
Posługując się parametrem $\theta$ określającym kąt pomiędzy wyznaczoną prostą a osią $x$ łatwo określić czy badane proste są do siebie równoległe. Aby wyznaczyć parametry prostej z równania \eqref{HOUGHTRANSFORM} zgodnie z \cite{houghTransform} należy każdemu punktowi tworzącemu prostą przypisać grupę punktów z przestrzeni Hough'a dla których wszystkie możliwe proste utworzone na ich podstawie zawierałyby badany punkt. Ostatecznie parametry prostej pochodzą z punktu, dla którego w przestrzeni Hough'a występuje największa gęstość powtarzających się punktów. Transformację przedstawia poniższy rysunek:
\begin{figure}[!h]
	\centering
	\includegraphics[scale=1]{rysunki/4_fig8}
	\caption{Transformacja dwóch punktów do dwóch krzywych w przestrzeni Hough'a. Źródło \cite{houghTransform}.}
\label{4_fig8}
\end{figure}
Dokładną analizę transformacji można znaleźć w \cite{houghTransform}.
Pojawiające się współczynniki $\alpha ,\beta ,\gamma $ w równaniu \eqref{SalientDistance} stanowią uprzednio definiowane wartości przypisujące procentowy wpływ poszczególnych członów na ostateczną wartość dopasowania $D(i,j)$. Według \cite{SalientStrucTexProp} najważniejszym dopasowaniem jest dopasowanie kolorów, następnie tekstur i krzywizn. Stąd należy przyjmować $\alpha >\beta >\gamma $ gdzie suma współczynników wynosi 1. W pracy zbadano powyższe rozwiązanie w ograniczeniu do wykorzystania członów $D_1\left(f^i_C,f^j_C\right)$ oraz $IP$. Człon $D_2\left(f^i_T,f^j_T\right)$ jest istotny w przypadku obrazów monochromatycznych o różnej teksturze. W przypadku obrazów kolorowych w większości przypadków linie granicy głównych struktur tworzone są poprzez gradienty kolorów. Zaletą metody jest stosowanie podzbiorów stanowiących źródło kopiowanych skrawków w nieznane części obrazu. W uproszczeniu można to przedstawić zgodnie z rysunkiem:
\begin{figure}[!h]
	\centering
	\includegraphics[scale=1]{rysunki/4_fig9}
	\caption{Grupowanie podzbiorów stanowiących źródło skrawków wykorzystywanych do syntezy podzbiorów nieznanego obszaru $\boldsymbol{\mathrm{\Omega }}$. źródło \cite{StructurePropagationManual}.}
\label{4_fig9}
\end{figure}
Pomimo automatycznej metody wykrywania i kontunuowania głównych struktur algorytm wymaga wielu operacji wykonywanych zdalnie przez użytkownika, takich jak stopień rozmycia wymagany do wprowadzenia w obrazie, wielkość kopiowanych skrawków $\psi $, czy też okien stanowiących podstawę do parowania danych struktur $f$. W przeciwieństwie do metod bazujących na rozwiązywaniu równań różniczkowych oraz metod bazujących na procesie dyfuzji proces wmalowywania opisany w aktualnym rozdziale pozbawiony jest wady w postaci rozmycia w odrestaurowanym obszarze. Jednym z problemów metody jest konieczność stosowania metody korekcji fotometrycznej zgodnie z \cite{StructurePropagationManual}, wygładzającej lokalne granice obrazu powstałe w wyniku syntezy skrawków obrazu $\psi $ w wyznaczanym obszarze $\mathrm{\Omega }$.
\chapter{Modyfikacje algorytmów}
\section{Modyfikacja algorytmu Criminisi.}
\label{ssec:crimMod}
Algorytm wypełniania skrawkami obrazu zbadano pod kątem ograniczenia źródła czerpania najlepszego dopasowania $\psi_{q}$ do okna będącego otoczeniem o promieniu $s_r$ rozważanego piksela $p$. Wtedy dla $q$ zachodzi zależność $q \in \mathcal{Z}$, $\mathcal{Z} = (p + \cdot(r))$, gdzie $\cdot(s_r))$ oznacza rozmiar otaczającego okna. Zmiana odnosi się do uprzedniej definicji \eqref{qSource}.
\section{Modyfikacja funkcji wagi.}
Podczas testowania algorytmu $NLCTV$ jedną z wad okazała się zbyt lokalna analiza obrazu, powodująca brak odpowiedniej kontynuacji struktury. Zwiększając parametry w postaci rozmiaru skrawka i rozmiaru okna algorytm wprowadza zbytnie uśrednienie nie pozwalające odpowiednio kontynuować tekstury obrazu przy zniekształceniu struktury. W celu uniknięcia zjawiska rozmycia tekstur, przy jednoczesnej poprawie zdolności algorytmu do kontynuacji większych struktur zaproponowano modyfikację funkcji wagi \eqref{NLWEIGHT} do następującej postaci:
\begin{align}
\begin{aligned}
w\left(x,y\right) &= {\mathrm{exp} \left\{-\frac{G_{\sigma }*{\left|I\left(x+\ \cdot \right)-I\left(y+\ \cdot \right)\right|}^2}{r^2}\right\} }\\
&\cdot {\mathrm{exp} \left\{-\frac{G_{\sigma }*{\left|I\left(x+\ s(\cdot) \right)-I\left(y+\ s(\cdot) \right)\right|}^2}{r^2}\right\} }
\label{NLWEIGHTMODIFIED}
\end{aligned}
\end{align}
W powyższej zależności człon $s(\cdot)$ oznacza przeskalowanie  domyślnej wartości przyjętego rozmiaru skrawka do rozmiaru $s$-krotnie większego. Edycja nie dotyczy pozostałej części  algorytmu i wpływa jedynie na wartość wagi.
\section{Modyfikacja wyznaczania wartości piksela w obrazie $u$.}
Złożoność obliczeniowa algorytmu $NLCTV$ skutkuje w względnie długim czasie wypełniania obrazu. W celu skrócenia czasu wyznaczania wynikowego obrazu zastosowano następującą aproksymację równania  \eqref{uNLCTV} pozwalającą uzyskać przybliżone wyniki do oryginalnego algorytmu:
\begin{align}
\begin{aligned}
{{\left(u_i\right)}_l}^{k+1} &= \frac{1}{{\left({\lambda }_D\right)}_l+2\mathrm{\Theta} \sum\limits_{j\in N_i} {\left(w_i\right)}_{l,j}\ } \Biggl[2\mathrm{\Theta }\sum_{j\in N_i} {{{\left(u^k_i\right)}_j\left(w_i\right)}_{l,j}\ }\\
&+ {\left({\lambda }_D\right)}_l{\left(f_i\right)}_l\Biggr]
\end{aligned}
\label{NLH1}
\end{align}
W powyższym równaniu eliminacja zmiennych $v$ oraz $b$ pozwala znacznie ograniczyć potrzeby pamięciowe programu oraz przyspieszyć działanie dzięki pominięciu obliczeń, wyrugowanych zmiennych.
\section{Połączenie metody Criminisi z funkcją wagi.}
Kolejną z pozytywnych prób modyfikacji algorytmu $NLCTV$ w pracy okazała się próba zastąpienia problemu minimalizacji energii \eqref{ENLCTV} opartej na funkcji wagi, metodą syntezy obrazu (bazującej na metodzie syntezy tekstury opisanej w \autoref{chap:StructureTextureNavierStokes}). Kroki nowego algorytmu można przedstawić w następującym schemacie:
\begin{enumerate}
\item
Ustawienie argumentów algorytmu: obraz $u$, maska obrazu $\chi$, wielkość okna $SW$, wielkość skrawka obrazu $PS$ 
\item
Wyznaczenie funkcji wagi $w$ zgodnie z \eqref{DNLWEIGHT} dla parametrów $SW$ i $PS$ i $\chi$
\item
Powtarzanie do uzyskania zbioru $\Omega = \emptyset$
\begin{enumerate}[a)]
\item
Znalezienie dla każdego piksela $p \in \partial\Omega$ najlepszego dopasowania $d \in D \cap N_p$, gdzie $N_p$ zbiór pikseli z okna utworzonego dla piksela $p$, dla którego zachodzi:
\begin{align}
d = \mathop{\mathrm{arg \ max}}_{t \in D \cap N_p} w(p,t)
\end{align}
a następnie przepisanie:
\begin{align}
u(p) = u(d)
\end{align}
\item
Pomniejszenie maski $\Omega$ o granicę $\partial\Omega$
\end{enumerate}
\end{enumerate}
Zastosowana modyfikacja pozwala na szybkie wyznaczenie wartości obrazu w szukanym obszarze $\Omega$. Przedstawiony sposób  pozwala uniknąć sytuacji, w której tworzony jest obcy kolor będący z poza gamy dostępnych kolorów w obrazie. Taki sposób wyznaczania wpływa na wartość wag obliczanych w kolejnych iteracjach i niweluje błąd wyznaczania wartości koloru z poza dostępnej gamy w kolejnych iteracjach dla $\partial \Omega$. Podobnie jak dla modelu $NLCTV$ można zastosować modyfikację funkcji wagi $w$ zgodnie z \eqref{NLWEIGHTMODIFIED}, w celu uzyskania podobnego efektu.
\chapter{Testy algorytmów}
\section{Analizowane obrazy.}
W niniejszej pracy testom poddano następującą grupę obrazów:
\begin{longtable}[h!]{|c|c|}
    \hline
    Obraz & Dane \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{imgmask/kotmyszm}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
	Wymiar: 500 x 375 \\
	Rozmiar maski: 28\% \\
	Nazwa: \kotmyszm
    \end{minipage} \\ \hline
    
    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{imgmask/maciek1m}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
	Wymiar: 410 x 308 \\
	Rozmiar maski: 28\% \\
	Nazwa: \maciekIm
    \end{minipage} \\ \hline
    
    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{imgmask/Obr1m}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
	Wymiar: 614 x 461 \\
	Rozmiar maski: 9\% \\
	Nazwa: \ObrIm
    \end{minipage} \\ \hline
    
    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{imgmask/Obr4m}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
	Wymiar: 576 x 360 \\
	Rozmiar maski: 7\% \\
	Nazwa: \ObrIVm
    \end{minipage} \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{imgmask/Obr5m}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
	Wymiar: 650 x 570 \\
	Rozmiar maski: 28\% \\
	Nazwa: \ObrVm
    \end{minipage} \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{imgmask/Obr6m}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
	Wymiar: 655 x 491 \\
	Rozmiar maski: 9\% \\
	Nazwa: \ObrVIm
    \end{minipage} \\ \hline
    
    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{imgmask/Obr15m}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
	Wymiar: 1772 x 1181 \\
	Rozmiar maski: 4.5\% \\
	Nazwa: \ObrXVm
    \end{minipage} \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{imgmask/Obr17m}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
	Wymiar: 206 x 308 \\
	Rozmiar maski: 14\% \\
	Nazwa: \ObrXVIIm
    \end{minipage} \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{imgmask/Obr19m}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
	Wymiar: 461 x 615 \\
	Rozmiar maski: 7\% \\
	Nazwa: \ObrXIXm
    \end{minipage} \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{imgmask/Obr28km}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
	Wymiar: 820 x 615 \\
	Rozmiar maski: 28\% \\
	Nazwa: \ObrXXVIIIkm
    \end{minipage} \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{imgmask/Osoba_drugam}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
	Wymiar: 2592 x 1944 \\
	Rozmiar maski: 28\% \\
	Nazwa: \OsobaDrugam
    \end{minipage} \\ \hline
    
    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{imgmask/Obr13m}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
	Wymiar: 1181 x 1772 \\
	Rozmiar maski: 4\% \\
	Nazwa: \ObrXIIIm
    \end{minipage} \\ \hline
    \caption{Obrazy poddane analizie.}
  \label{imgmasks}
\end{longtable}
\section{Uzupełnianie kawałkami obrazu.}
\subsection{Metoda Criminisi.}
Wszystkie z przeprowadzonych testów wykonano w przestrzeni $RGB$. Dystans pomiędzy skrawkami wyznaczono według przytoczonej w poświęconym metodzie rozdziale normy Frobenius'a \eqref{FROBENIUS2}. Przykładowe wyniki przedstawia poniższa tabela:
\begin{longtable}[h!]{|c|c|}
    \hline
    Obraz & Dane \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/CRIM2004/Obr17/{Obr17m.pngpr_3sr_8006alfa_0.2t_31.7202}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item pr: 3
        \item Czas: 31.72s
    \end{itemize}
    \end{minipage} \\ \hline
    
    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/CRIM2004/Obr17/{Obr17m.pngpr_15sr_8006alfa_0.2t_22.4205}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item pr: 15
        \item Czas: 22.42s
    \end{itemize}
    \end{minipage} \\ \hline  
    
    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/CRIM2004/Obr17/{Obr17m.pngpr_23sr_8006alfa_0.2t_20.7783}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item pr: 23
        \item Czas: 20.77s
    \end{itemize}
    \end{minipage} \\ \hline
    
    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/CRIM2004/Obr4/{Obr4m.pngpr_3sr_8010alfa_0.2t_213.2492}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item pr: 3
        \item Czas: 213.25s
    \end{itemize}
    \end{minipage} \\ \hline
    
    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/CRIM2004/Obr4/{Obr4m.pngpr_15sr_8010alfa_0.2t_113.4021}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item pr: 15
        \item Czas: 113.40s
    \end{itemize}
    \end{minipage} \\ \hline  
    
    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/CRIM2004/Obr4/{Obr4m.pngpr_23sr_8010alfa_0.2t_134.3072}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item pr: 23
        \item Czas: 134.31s
    \end{itemize}
    \end{minipage} \\ \hline
    
    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/CRIM2004/Obr19/{Obr19m.pngpr_3sr_8011alfa_0.2t_294.2353}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item pr: 3
        \item Czas: 294.24s
    \end{itemize}
    \end{minipage} \\ \hline
    
    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/CRIM2004/Obr19/{Obr19m.pngpr_11sr_8011alfa_0.2t_181.0897}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item pr: 11
        \item Czas: 181.10s
    \end{itemize}
    \end{minipage} \\ \hline  
    
    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/CRIM2004/Obr19/{Obr19m.pngpr_23sr_8011alfa_0.2t_196.3067}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item pr: 23
        \item Czas: 196.31s
    \end{itemize}
    \end{minipage} \\ \hline
    
    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/CRIM2004/Obr13/{Obr13m.pngpr_3sr_8012alfa_0.2t_565.4799}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item pr: 3
        \item Czas: 565.48s
    \end{itemize}
    \end{minipage} \\ \hline
    
    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/CRIM2004/Obr13/{Obr13m.pngpr_11sr_8012alfa_0.2t_294.7297}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item pr: 11
        \item Czas: 294.73s
    \end{itemize}
    \end{minipage} \\ \hline  
    
    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/CRIM2004/Obr13/{Obr13m.pngpr_23sr_8012alfa_0.2t_328.5629}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item pr: 23
        \item Czas: 328.56s
    \end{itemize}
    \end{minipage} \\ \hline
    
  \caption{Wyniki metody Criminisi.}
  \label{CRIMTEST}
\end{longtable}
Wyniki przedstawione w tabeli wyznaczono dla optymalnego ustawienia parametru $\alpha=0.2$. Zmiana wspomnianego parametru w ogólnym charakterze rozważanej metodyki nie wpływała na końcowe obrazy. W zależności od rozpatrywanego obrazu rozmiar skrawka może wpływać na odpowiedniość syntezy struktury. W przypadku \ObrXVIIm \ mały rozmiar skrawka skutkuje w odpowiedniej kontynuacji dachu budynku. W przypadku \ObrIVm \ średni wymiar skrawka pozwala na odpowiednią syntezę plaży. W przypadku obrazu \ObrVIm \ największy rozmiar skrawka zagwarantował dla obserwatora względnie najbliższe odtworzenie zawartości maski. W ogólnym rozrachunku metoda w każdym z rezultatów wprowadza wadę w postaci nieprawidłowego elementu w danej ze struktur obrazu. 
\subsection{Główne struktury obrazu.}
W celu zminimalizowania efektu zgodnie z \cite{StructurePropagationManual} algorytm wmalowywania przebadano pod kątem priorytetowego wypełnienia głównych struktur obrazu zgodnie z wytycznymi wprowadzonymi manualnie przez użytkownika. Punkty linii głównej struktury znajdującej się w obszarze maski stanowią miejsca, które wypełniane są priorytetowo.

\begin{longtable}[h!]{|c|c|}
    \hline
    Obraz & Dane \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/SALCRIM2004/SALIENT/{5_9_Obr6m}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item pr: 9
        \item Główne struktury: 5
    \end{itemize}
    \end{minipage} \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/SALCRIM2004/SALIENT/{4_8_Obr13m}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item pr: 8
        \item Główne struktury: 4
    \end{itemize}
    \end{minipage} \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/SALCRIM2004/SALIENT/{3_4_Obr17m}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item pr: 4
        \item Główne struktury: 3
    \end{itemize}
    \end{minipage} \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/SALCRIM2004/SALIENT/{1_12_Obr19m}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item pr: 12
        \item Główne struktury: 1
    \end{itemize}
    \end{minipage} \\ \hline
        
	\caption{Główne struktury testowanych obrazów manualnie wprowadzone przez użytkownika.}
\end{longtable}
Linie granic głównych struktur przedstawiono kolorem czerwonym. Część wspólna obrazu oryginalnego poza maską wraz z linią stanowią zbiór, z którego pobierane jest najlepsze dopasowanie. Wartość $p_r$ manualnie ustawiono na minimalną wartość zdolną zachować właściwości charakterystyczne dla danej granicy w pełnym zakresie linii. Pośrednie wyniki wypełniania struktur przedstawiono w tabeli:

\begin{longtable}[h!]{|c|c|}
    \hline
    Obraz & Dane \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/SALCRIM2004/TESTY/Obr6/{5_9_Obr6m.pngpr_9sr_100000alfa_0.2t_0.49515}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item Czas: 0.50s
        \item Procent wyznaczonej maski: 32.1 \%
    \end{itemize}
    \end{minipage} \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/SALCRIM2004/TESTY/Obr13/{4_8_Obr13m.pngpr_8sr_100000alfa_0.2t_0.31031}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item Czas: 0.31s
        \item Procent wyznaczonej maski: 16.27 \%
    \end{itemize}
    \end{minipage} \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/SALCRIM2004/TESTY/Obr17/{3_4_Obr17m.pngpr_4sr_12alfa_0.2t_0.080489}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item Czas: 0.08s
        \item Procent wyznaczonej maski: 12.24 \%
    \end{itemize}
    \end{minipage} \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/SALCRIM2004/TESTY/Obr19/{1_12_Obr19m.pngpr_12sr_100000alfa_0.2t_0.36266}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
        \item Czas: 0.36s
        \item Procent wyznaczonej maski: 22.85 \%
    \end{itemize}
    \end{minipage} \\ \hline
        
	\caption{Wynik wyznaczania głównych struktur testowanych obrazów.}
\end{longtable}
Wyznaczenie głównych struktur w każdym z testowych obrazów nie wymagało czasu obliczeniowego większego niż $1s$. W uproszeniu można przyjąć, że algorytm pozwala oszczędzić czas potrzebny na proces wmalowywania równy procentowi wyznaczonej maski z całkowitego czasu oryginalnej metody Criminisi. Ostatecznie przykładowe wyniki przedstawia  tabela:

\begin{longtable}[h!]{|c|c|}
    \hline
    Obraz & Dane \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/SALCRIM2004/TESTY/Obr6/{5_9_Obr6m.pngpr_9sr_63alfa_0.2t_12.0559}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
    	\item pr: 9
        \item Czas: 12.05s
    \end{itemize}
    \end{minipage} \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/SALCRIM2004/TESTY/Obr13/{4_8_Obr13m.pngpr_8sr_56alfa_0.2t_16.2741}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
    	\item pr: 8
        \item Czas: 16.27s
    \end{itemize}
    \end{minipage} \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/SALCRIM2004/TESTY/Obr17/{3_4_Obr17m.pngpr_4sr_12alfa_0.2t_1.5704}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
    	\item pr: 4
        \item Czas: 1.57s
    \end{itemize}
    \end{minipage} \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=5.8cm]{TESTY/SALCRIM2004/TESTY/Obr19/{1_12_Obr19m.pngpr_12sr_84alfa_0.2t_12.8458}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    \begin{itemize}
    	\item pr: 12
        \item Czas: 12.85s
    \end{itemize}
    \end{minipage} \\ \hline
        
	\caption{Wynik wyznaczania głównych struktur testowanych obrazów.}
	\label{CrimSalStructRes}
\end{longtable}

Wszystkie z przedstawionych powyżej wyników wykonano ograniczając okno poszukiwań zgodnie z \autoref{ssec:crimMod} przyjmując jako parametr $s_r = 3 \cdot 	p_r$. W przypadku obrazów \ObrVIm , \ObrXVIIm \ i \ObrXIXm \ wyniki w porównaniu do \autoref{CRIMTEST} posiadają lepszą syntezę głównych struktur, a ograniczenie okna poszukiwania przyspiesza o rząd wielkości czas wyznaczenia głównego obrazu. W przypadku \ObrXVm \ i \ObrXIIIm \ pomimo wstępnej syntezy głównych struktur nie udało się uniknąć błędów w postaci obcych wartości w różnych strukturach obrazu. Ograniczenie okna poszukiwania może wprowadzać dodatkowe błędy w przypadku niejednoznaczności struktur w pobliżu granicy maski. Rozważając prawą część maski obrazu \ObrXVIIm \ algorytm wypełniania ogranicza źródło wzorca do będącego błędnym źródłem osoby pozostawionej w obrazie (postać z prawej strony obrazu traktowana jest jako niejednoznaczność).Wadą algorytmu wypełniania jest konieczność dodatkowej korekcji fotometrycznej uzyskanego wyniku zgodnie z \cite{StructurePropagationManual}. przedstawionym w \autoref{7_fig1}. 
\begin{figure}[!h]
	\centering
	\includegraphics[scale=0.5]{rysunki/7_fig1}
	\caption{Korekcja fotometryczna obrazu w przypadku propagacji głównych struktur obrazu. Źródło \cite{StructurePropagationManual}.}
	\label{7_fig1} 
\end{figure}
Ograniczenie błędów w postaci nieodpowiedniej syntezy struktur obrazu w badaniach korygowane jest wprowadzaniem modyfikacji normy \eqref{FROBENIUS2} uwzględniającej wartości posegmentowanego obrazu, bądź dodatkowej wyznaczanej wartości $\nabla I$. Błąd w największym stopniu ograniczyć można poprzez dodatkowy wejściowy parametr algorytmu w postaci dodatkowej maski $\Omega '$ definiowanej przez użytkownika stanowiącej zbiór pikseli, które nie powinny pojawić się we wmalowywanym obszarze. Niech:
\begin{equation}
{\lambda }'\left(x\right)=\left\{ \begin{array}{c}
0\ x\ \epsilon \ \mathrm{\Omega } \\ 
1\ x\ \epsilon \ D/\mathrm{\Omega } \end{array}
\right\}
\end{equation}
Wtedy dla każdego ${\varphi }_q$ zachodzi warunek:
\begin{align}
\forall_{x \in {\varphi }_q}: {\lambda }'(x) = 1
\end{align}
\subsection{Automatyczne wykrywanie struktur.}
Autorzy w \cite{SalientStrucTexProp} nie przedstawiają dokładnego sposobu wyznaczania głównych struktur, ich parowania, a następnie wyznaczania równań kontynuacji w obszar maski. Algorytm opisany w pracy zależy od wielu zmiennych definiowanych przez użytkownika mających wpływ na ostateczny wynik, takich jak:
\begin{itemize}
\item parametry filtru usuwającego mniej znaczące krawędzie obrazu
\item ilość głównych kolorów na które zostanie posegmentowany obraz
\item rozmiar okna otaczający główną strukturę brany pod uwagę podczas wyznaczania dystansu koloru
\item waga poszczególnych członów w równaniu \eqref{SalientDistance} mające wpływ na parowanie struktur
\end{itemize}
Dobór każdego z parametrów nie jest uniwersalny i zależy od rozpatrywanego obrazu. Problematyczność doboru parametrów i dokładność uzyskiwanych wyników potwierdziły konieczność znacznie głębszej analizy problemu. Dokładność wyników uzyskanych w poprzednim podrozdziale (przy manualnym oznaczaniu głównych struktur) w stosunku do wymaganego stopnia analizy skłoniły do badań pozostałych algorytmów.
\section{Nielokalny model NLCTV.}
\subsection{Modyfikacja wyznaczania wartości piksela w obrazie $u$.}
Porównanie wyników algorytmu oryginalnego i uproszczonego przedstawia \autoref{NLCTVVSNLHI}. Podobieństwo obrazów mierzy się współczynnikiem:
\begin{align}
f = \frac{100}{256}\frac{1}{n| \Omega |} \sum^c_{k=1}{\sum^m_{i=1}{\sum^n_{j=1}{ | I_1(i,j,k)-I_2(i,j,k) |}}} %
\end{align}
gdzie $n$ oznacza liczbę warstw obrazu tworzących kolor, $m, \ n$ rozmiar obrazu, $|\Omega|$ pole obszaru maski. Do porównania obrazów wykorzystano dodatkową grupę przedstawioną w \autoref{NLCTVVSNLHIIM}.

\begin{longtable}[h!]{| c | c |}
    \hline
    Obraz & Dane \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=4cm]{TESTY/NLCTVNLH1/IM/bar}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
	Wymiar: 81 x 81 \\
	Rozmiar maski: 10\% \\
	Nazwa: \XXVIII
    \end{minipage} \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=4cm]{TESTY/NLCTVNLH1/IM/TEST}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
	Wymiar: 113 x 66 \\
	Rozmiar maski: 6\% \\
	Nazwa: \TEST
    \end{minipage} \\ \hline
    
    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=4cm]{TESTY/NLCTVNLH1/IM/Wood}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
	Wymiar: 134 x 81 \\
	Rozmiar maski: 11\% \\
	Nazwa: \Wood
    \end{minipage} \\ \hline
  \caption{Dodatkowa grupa obrazów testowych dla nielokalnego modelu $NLCTV$.}
  \label{NLCTVVSNLHIIM}
\end{longtable}

\begin{longtable}[h!]{|c|c|}
    \hline
    Oryginalny & Uproszczony \\ \hline
    
    \multicolumn{2}{|c|}{
    	Parametry:  $h=2$, $p_r=2$, $s_r=4$, $\lambda=0.01$, $\sigma=0.5$
    } \\

    \multicolumn{2}{|c|}{
    	Wyniki: $t_1=150.07$, $t_2=13.06$, $f=0.31$\%
    } \\ \hline
    
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVNLH1/ORIG/bh_2t_150.07}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVNLH1/NLH1/bh_2_t_13.06}.png}
    \vspace{0.5cm}
    \end{minipage} \\ \hline
    
    \multicolumn{2}{|c|}{
    	Parametry:  $h=15$, $p_r=2$, $s_r=4$, $\lambda=0.01$, $\sigma=0.5$
    } \\

    \multicolumn{2}{|c|}{
    	Wyniki: $t_1=172.46$, $t_2=13.99$, $f=2.41$\%
    } \\ \hline

    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVNLH1/ORIG/bh_15_t_172.46}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVNLH1/NLH1/bh_15_t_13.99}.png}
    \vspace{0.5cm}
    \end{minipage} \\ \hline
    
    \multicolumn{2}{|c|}{
    	Parametry:  $h=2$, $p_r=2$, $s_r=4$, $\lambda=0.01$, $\sigma=0.5$
    } \\ 

    \multicolumn{2}{|c|}{
    	Wyniki: $t_1=219.95$ $t_2=12.96$ $f=0.8$\%
    } \\ \hline

    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVNLH1/ORIG/th_2_t_219.95}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVNLH1/NLH1/th_2t_12.96}.png}
    \vspace{0.5cm}
    \end{minipage} \\ \hline
    
    \multicolumn{2}{|c|}{
    	Parametry:  $h=15$, $p_r=2$, $s_r=4$, $\lambda=0.01$, $\sigma=0.5$
    } \\   

    \multicolumn{2}{|c|}{
    	Wyniki: $t_1=227.01$ $t_2=13.13$ $f=2.2$\%
    } \\ \hline    

    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVNLH1/ORIG/th_10_t_227.01}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVNLH1/NLH1/th_10_t_13.13}.png}
    \vspace{0.5cm}
    \end{minipage} \\ \hline

    \multicolumn{2}{|c|}{
    	Parametry:  $h=0.5$, $p_r=7$, $s_r=15$, $\lambda=0.01$, $\sigma=0.5$
    } \\  

    \multicolumn{2}{|c|}{
    	Wyniki: $t_1=3870.58$ $t_2=122.32$ $f=0.13$\%
    } \\ \hline    
    
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[scale=1]{{TESTY/NLCTVNLH1/ORIG/nlctvgs_r_15p_r7h_0.5sw_1_t_3870.584639}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[scale=1]{{TESTY/NLCTVNLH1/NLH1/nlh1ws_r_15p_r7h_0.5sw_1_t_122.321}.png}
    \vspace{0.5cm}
    \end{minipage} \\ \hline
  
	\caption{Wynik wyznaczania głównych struktur testowanych obrazów.}
	\label{NLCTVVSNLHI}
\end{longtable}
Maksymalny procentowy błąd $f$ w przytoczonych testach nie przekracza wartości 3\% i można uznać za pomijalny. Różnica pomiędzy obrazami rośnie wraz ze wzrostem współczynnika $h$. Wizualne dostrzeżenie różnicy w obrazach obliczonych przez wspomniane algorytmy jest niemal niemożliwe. Wszystkie z pozostałych testów wykonano dla algorytmu uproszczonego. Czasy uzyskania wyników różnią się o rząd wielkości. Uproszczony algorytm w znacznym stopniu przyspiesza algorytm wmalowywania. Przykłądowe wyniki dla różnych parametrów algorytmu przedstawia tabela \autoref{NLH1Tab}.

\begin{longtable}[h!]{|c|c|}
    \hline
    \multicolumn{2}{|c|}{
    	Obrazy
    } \\ \hline 
    \multicolumn{2}{|c|}{
		Wpływ parametru $h$ na odwzorowanie tekstur i struktur
    } \\ \hline 
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    $s_r$: 25 \\
    $p_r$: 10 \\
    $h$: 2 \\
    Wyniki: \\ 
    Czas: 2041.85s 
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    $s_r$: 25 \\
    $p_r$: 10 \\
    $h$: 5 \\
    Wyniki: \\ 
    Czas: 2299.78s  
    \vspace{0.5cm}
    \end{minipage} \\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVORIG/Adds/Obr17m.pngs_r_25p_r10h_2sw_1t_2041.8515}.png}
    \vspace{0.5cm}
    \end{minipage}
	&
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVORIG/Adds/Obr17m.pngs_r_25p_r10h_5sw_1t_2299.7753}.png}
    \vspace{0.5cm}
    \end{minipage}\\ \hline

    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    $s_r$: 25 \\
    $p_r$: 10 \\
    $h$: 2 \\
    Wyniki: \\ 
    Czas: 2041.85s 
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    $s_r$: 25 \\
    $p_r$: 10 \\
    $h$: 5 \\
    Wyniki: \\ 
    Czas: 2299.78s  
    \vspace{0.5cm}
    \end{minipage} \\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVORIG/Adds/Obr19m.pngs_r_20p_r7h_2sw_1t_5032.0394}.png}
    \vspace{0.5cm}
    \end{minipage}
	&
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVORIG/Adds/Obr19m.pngs_r_20p_r7h_5sw_3t_21013.3605}.png}
    \vspace{0.5cm}
    \end{minipage}\\ \hline

    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    $s_r$: 9 \\
    $p_r$: 3 \\
    $h$: 10 \\
    Wyniki: \\ 
    Czas: 387.14s 
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    $s_r$: 9 \\
    $p_r$: 3 \\
    $h$: 12 \\
    Wyniki: \\ 
    Czas: 395.05s  
    \vspace{0.5cm}
    \end{minipage} \\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVORIG/Obr6/Obr6m.pngs_r_9p_r3h_10sw_1t_387.1384}.png}
    \vspace{0.5cm}
    \end{minipage}
	&
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVORIG/Obr6/Obr6m.pngs_r_9p_r3h_12sw_1t_395.0529}.png}
    \vspace{0.5cm}
    \end{minipage}\\ \hline

    \multicolumn{2}{|c|}{
		Wpływ parametrów $s_r$ i $p_r$ na odwzorowanie tekstur i struktur. \newline
    } \\

    \multicolumn{2}{|c|}{
		($h$ dla małych $s_r$ i $p_r$ wyznaczone jako minimalne stabilne)
    } \\ \hline 

    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    $s_r$: 24 \\
    $p_r$: 8 \\
    $h$: 3 \\
    Wyniki: \\ 
    Czas: 38923.738s 
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    $s_r$: 5 \\
    $p_r$: 3 \\
    $h$: 10 \\
    Wyniki: \\ 
    Czas: 150.56s  
    \vspace{0.5cm}
    \end{minipage} \\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVORIG/Adds/kotmyszm.bmps_r_24p_r8h_3sw_1t_38923.7386}.png}
    \vspace{0.5cm}
    \end{minipage}
	&
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVORIG/KotMysz/kotmysz_m.pngs_r_5p_r3h_10sw_1t_150.5554}.png}
    \vspace{0.5cm}
    \end{minipage}\\ \hline

    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    $s_r$: 20 \\
    $p_r$: 7 \\
    $h$: 2 \\
    Wyniki: \\ 
    Czas: 16271.66s 
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    $s_r$: 5 \\
    $p_r$: 3 \\
    $h$: 10 \\
    Wyniki: \\ 
    Czas: 150.56s  
    \vspace{0.5cm}
    \end{minipage} \\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVORIG/Adds/Obr1m.pngs_r_20p_r7h_2sw_1t_16271.6586}.png}
    \vspace{0.5cm}
    \end{minipage}
	&
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVORIG/Obr1/Obr1m.pngs_r_5p_r3h_10sw_1t_104.9599}.png}
    \vspace{0.5cm}
    \end{minipage}\\ \hline

    \caption{Wynikowe obrazu dla algorytmu $NLCTV$.}
    \label{NLH1Tab}
\end{longtable}

Nielokalny model wariacyjny w pierwszych z publikacji dotyczących przetwarzania obrazów stosowany jest do filtracji, usuwania elementów tekstury i szumu, segmentacji na strukturę i teksturę, przykład \cite{buades2005non}. Istotnym parametrem algorytmu jest parametr $h$, który w przypadku małych wartości nadaje ostry charakter funkcji wagi $w$. W przypadku zwiększania wartości $h$ gradient wartości wagi $w$ maleje co skutkuje w dokładniejszym usunięciu szumów i tekstury w obrazie. Duża wartość parametru $h$ przekłada się na niską dokładność wmalowania obrazu: rozmycie odtworzonej struktury i braku kontynuacji tekstury. W przypadku małych wartości parametru $s_r$ i $p_r$, przy małej wartości parametru $h$ i braku ściśle powtarzających się tekstur obrazu algorytm w wyniku generuje kolory będące z poza gammy dostarczanej z obrazem bądź przechodzi w obszar niestabilności. W przypadku niskich wartości parametru  $s_r$ i $p_r$, przy dużej wartości parametru $h$ w wyniku otrzymuje się rozmyty obraz. Duża wartość parametru $h$ generuje prawidłowe wyniki wyłącznie w sytuacji ściśle powtarzających się tekstur obrazu znajdujących się w jednej strukturze. Zastosowanie odpowiednio dużych wartości parametrów $s_r$, $p_r$ pozwala przyjąć małą wartość parametru $h$ z zachowaniem stabilności skutkując w prawidłowej syntezie wyznaczanego obszaru. Wadą algorytmu jest znacznie rosnąca ilość czasu potrzebna na obliczenie obrazu maski w przypadku dużych wartości $s_r$ i $p_r$ pomimo zastosowania algorytmu uproszczonego. W głównej mierze do przyrostu czasu przyczynia się funkcja wyznaczania wagi $w$. Dla komputera wyposażonego w 8 GB pamięci RAM górnym limitem parametrów jest $s_r <30$, $p_r$ dla obrazu o wymiarze $500x500$. Zalecane parametry algorytmu:
\begin{enumerate}
\item Obraz z ściśle powtarzającą się teksturą z maską w zakresie jednej struktury
\begin{itemize}
\item $s_r < 6$
\item $p_r < 4$
\item $h > 5$
\end{itemize}
\item Pozostałe obrazy
\begin{itemize}
\item $s_r > 15$
\item $p_r > 5$
\item $h < 5$
\end{itemize}
\end{enumerate}
Wadą algorytmu jest brak skutecznej kontynuacji charakteryzującej się losowością tekstury - \kotmyszm, \ObrIm .
\subsection{Modyfikacja funkcji wagi.}

\begin{longtable}[h!]{|c|c|}
    \hline
    \multicolumn{2}{|c|}{
    	Obrazy
    } \\ \hline 
    \multicolumn{2}{|c|}{
		Wpływ parametru $sw$ na odwzorowanie tekstur i struktur
    } \\ \hline 
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    $s_r$: 23 \\
    $p_r$: 10 \\
    $h$: 3 \\
    $sw$: 3 \\
    Wyniki: \\ 
    Czas: 27579.38s 
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    $s_r$: 23 \\
    $p_r$: 10 \\
    $h$: 3 \\
    $sw$: 1 \\
    Wyniki: \\ 
    Czas: 4987.13s  
    \vspace{0.5cm}
    \end{minipage} \\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVORIG/Adds/maciek1m.pngs_r_23p_r10h_3sw_3t_27579.3828}.png}
    \vspace{0.5cm}
    \end{minipage}
	&
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVORIG/Adds/maciek1m.pngs_r_23p_r10h_3sw_1t_4987.1313}.png}
    \vspace{0.5cm}
    \end{minipage}\\ \hline

    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    $s_r$: 25 \\
    $p_r$: 10 \\
    $h$: 5 \\
    $sw$: 3 \\
    Wyniki: \\ 
    Czas: 12766.72s 
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    $s_r$: 25 \\
    $p_r$: 10 \\
    $h$: 5 \\
    $sw$: 1 \\
    Wyniki: \\ 
    Czas: 2299.78s  
    \vspace{0.5cm}
    \end{minipage} \\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVORIG/Adds/Obr17m.pngs_r_25p_r10h_5sw_3t_12766.7184}.png}
    \vspace{0.5cm}
    \end{minipage}
	&
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVORIG/Adds/Obr17m.pngs_r_25p_r10h_5sw_1t_2299.7753}.png}
    \vspace{0.5cm}
    \end{minipage}\\ \hline

    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    $s_r$: 20 \\
    $p_r$: 7 \\
    $h$: 3 \\
    $sw$: 3 \\
    Wyniki: \\ 
    Czas: 21601.97s 
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    $s_r$: 20 \\
    $p_r$: 7 \\
    $h$: 3 \\
    $sw$: 1 \\
    Wyniki: \\ 
    Czas: 5037.52s  
    \vspace{0.5cm}
    \end{minipage} \\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVORIG/Adds/Obr19m.pngs_r_20p_r7h_3sw_3t_21601.9746}.png}
    \vspace{0.5cm}
    \end{minipage}
	&
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/NLCTVORIG/Adds/Obr19m.pngs_r_20p_r7h_3sw_1t_5037.5187}.png}
    \vspace{0.5cm}
    \end{minipage}\\ \hline

    \caption{Wynikowe obrazu dla algorytmu $NLCTV$ z modyfikacją wagi.}
    \label{NLH1SWOVER1}
\end{longtable}
Wyniki uzyskane dla zmodyfikowanej funkcji wagi charakteryzują się zdolnością do dokładniejszej kontynuacji struktury, nie wpływając w znacznym stopniu na poprawę tekstury obrazu. Wadą algorytmu jest znaczne wydłużenie czasu wyznaczenia funkcji wagi, będącej najistotniejszym czynnikiem wpływającym na długość trwania obliczeń.  
\subsection{Połączenie metody Criminisi z funkcją wagi.}


\section{Wariacyjny, nielokalny model wmalowywania.}
Wszystkie z przeprowadzonych testów wykonano dla stałych parametrów związanych z terminem "pewności" równych:
\begin{itemize}
\item
ilość stopni tworzonej piramidy $S=7$
\item
rozmiar obrazu dla najmniejszego ze stopnia w piramidzie 
\begin{align}
A_{S-1}=\frac{1.5 \cdot ps}{\mathrm{max}_{x \in \mathcal{O}}d(x,\mathcal{O}^{c})}
\end{align}
gdzie $ps = |\Omega|$ oznacza długość boku skrawka.
\end{itemize}
Parametry związane z "pewnością" co do pikseli wewnątrz maski przyjęto jako stałe i równe:
\begin{itemize}
\item
sposób rozkładu funkcji w przestrzeni $t_{c}=5.0$
\item 
asymptota, do której dąży funkcja $c_{0}=0.1$
\end{itemize}
Żaden z obrazów przed operacją wmalowywania nie był wstępnie inicjalizowany. \eqref{Poisson}.
\begin{longtable}[h!]{|c|c|}
    \hline
    \multicolumn{2}{|c|}{
    	Obrazy
    } \\ \hline 
    \multicolumn{2}{|c|}{
    	Porównanie odwzorowania tekstur w zależności od normy
    } \\ \hline 
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma: medianowa \\
    Promień skrawka: 7 \\
    Wyniki: \\ 
    Czas: 234.16s 
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma: uśredniająca \\
    Promień skrawka: 7 \\
    Wyniki: \\ 
    Czas: 258.49s  
    \vspace{0.5cm}
    \end{minipage} \\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/KotMysz/kotmyszm.png_nlmedians_sc7_0.124744_initnone_ps7_10000_conf5_0.1_t234.135}.png}
    \vspace{0.5cm}
    \end{minipage}
	&
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/KotMysz/kotmyszm.png_nlmeans_sc7_0.124744_initnone_ps7_10000_conf5_0.1_t258.485}.png}
    \vspace{0.5cm}
    \end{minipage}\\ \hline

    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma: medianowa \\
    Promień skrawka: 7 \\
    Wyniki: \\ 
    Czas: 234.16s 
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma: Poisson'a \\
    Promień skrawka: 7 \\
    Wyniki: \\ 
    Czas: 763.77s  
    \vspace{0.5cm}
    \end{minipage} \\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/KotMysz/kotmyszm.png_nlmedians_sc7_0.124744_initnone_ps7_10000_conf5_0.1_t234.135}.png}
    \vspace{0.5cm}
    \end{minipage}
	&
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/KotMysz/kotmyszm.png_nlpoisson_l0.1_sc7_0.124744_initnone_ps7_10000_conf5_0.1_t763.773}.png}
    \vspace{0.5cm}
    \end{minipage}\\ \hline


    \multicolumn{2}{|c|}{
    	Porównanie uzyskanej spójności struktur i tekstur w zależności od normy
    } \\ \hline 
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma:  Poisson'a $(L^2)$\\
    Promień skrawka: 9 \\
    Wyniki: \\ 
    Czas: 391.50s 
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma: medianowa $(L^1)$ \\
    Promień skrawka: 9 \\
    Wyniki: \\ 
    Czas: 146.55s  
    \vspace{0.5cm}
    \end{minipage}\\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Obr4/Obr4m.png_nlpoisson_l0.1_sc7_0.321429_initnone_ps9_10000_conf5_0.1_t391.501}.png}
    \vspace{0.5cm}
    \end{minipage}
	&
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Obr4/Obr4m.png_nlmedians_sc7_0.321429_initnone_ps9_10000_conf5_0.1_t146.551}.png}
    \vspace{0.5cm}
    \end{minipage}\\ \hline

    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma:  Uśredniająca $(L^2)$\\
    Promień skrawka: 9 \\
    Wyniki: \\ 
    Czas: 150.99s 
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma: medianowa $(L^1)$ \\
    Promień skrawka: 9 \\
    Wyniki: \\ 
    Czas: 146.55s  
    \vspace{0.5cm}
    \end{minipage}\\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Obr4/Obr4m.png_nlmeans_sc7_0.321429_initnone_ps9_10000_conf5_0.1_t150.992}.png}
    \vspace{0.5cm}
    \end{minipage}
	&
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Obr4/Obr4m.png_nlmedians_sc7_0.321429_initnone_ps9_10000_conf5_0.1_t146.551}.png}
    \vspace{0.5cm}
    \end{minipage}\\ \hline
    
    \multicolumn{2}{|c|}{
    	Porównanie uzyskanej spójności struktur i tekstur w zależności rozmiaru skrawka
    } \\ \hline 
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma:  Poisson'a\\
    Promień skrawka: 13 \\
    Wyniki: \\ 
    Czas: 711.47s 
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma: Poisson'a\\
    Promień skrawka: 3 \\
    Wyniki: \\ 
    Czas: 81.19s  
    \vspace{0.5cm}
    \end{minipage}\\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Maciek1/maciek1m.png_nlpoisson_l0.1_sc7_0.414894_initnone_ps13_10000_conf5_0.1_t711.471}.png}
    \vspace{0.5cm}
    \end{minipage}
	&
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Maciek1/maciek1m.png_nlpoisson_l0.1_sc7_0.0957447_initnone_ps3_10000_conf5_0.1_t81.1885}.png}
    \vspace{0.5cm}
    \end{minipage}\\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma:  medianowa\\
    Promień skrawka: 13 \\
    Wyniki: \\ 
    Czas: 259.07s 
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma: medianowa\\
    Promień skrawka: 3 \\
    Wyniki: \\ 
    Czas: 16.24s  
    \vspace{0.5cm}
    \end{minipage}\\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Maciek1/maciek1m.png_nlmedians_sc7_0.414894_initnone_ps13_10000_conf5_0.1_t259.072}.png}
    \vspace{0.5cm}
    \end{minipage}
	&
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Maciek1/maciek1m.png_nlmedians_sc7_0.0957447_initnone_ps3_10000_conf5_0.1_t16.2396}.png}
    \vspace{0.5cm}
    \end{minipage}\\ \hline
    
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma:  uśredniająca\\
    Promień skrawka: 13 \\
    Wyniki: \\ 
    Czas: 370.96s 
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma: uśredniająca\\
    Promień skrawka: 3 \\
    Wyniki: \\ 
    Czas: 20.50s  
    \vspace{0.5cm}
    \end{minipage}\\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Maciek1/maciek1m.png_nlmeans_sc7_0.414894_initnone_ps13_10000_conf5_0.1_t370.964}.png}
    \vspace{0.5cm}
    \end{minipage}
	&
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Maciek1/maciek1m.png_nlmeans_sc7_0.0957447_initnone_ps3_10000_conf5_0.1_t20.4957}.png}
    \vspace{0.5cm}
    \end{minipage}\\ \hline


    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma:  Poisson'a\\
    Promień skrawka: 11 \\
    Wyniki: \\ 
    Czas: 715.38s 
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma: Poisson'a\\
    Promień skrawka: 3 \\
    Wyniki: \\ 
    Czas: 37.36s  
    \vspace{0.5cm}
    \end{minipage}\\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Obr17/Obr17m.png_nlpoisson_l0.1_sc7_0.771837_initnone_ps11_10000_conf5_0.1_t715.376}.png}
    \vspace{0.5cm}
    \end{minipage}
	&
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Obr17/Obr17m.png_nlpoisson_l0.1_sc7_0.210501_initnone_ps3_10000_conf5_0.1_t37.3627}.png}
    \vspace{0.5cm}
    \end{minipage}\\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma:  medianowa\\
    Promień skrawka: 13 \\
    Wyniki: \\ 
    Czas: 374.35s 
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma: medianowa\\
    Promień skrawka: 3 \\
    Wyniki: \\ 
    Czas: 12.14s  
    \vspace{0.5cm}
    \end{minipage}\\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Obr17/Obr17m.png_nlmedians_sc7_0.912172_initnone_ps13_10000_conf5_0.1_t374.347}.png}
    \vspace{0.5cm}
    \end{minipage}
	&
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Obr17/Obr17m.png_nlmedians_sc7_0.210501_initnone_ps3_10000_conf5_0.1_t12.1388}.png}
    \vspace{0.5cm}
    \end{minipage}\\ \hline
    
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma:  uśredniająca\\
    Promień skrawka: 13 \\
    Wyniki: \\ 
    Czas: 585.15s 
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma: uśredniająca\\
    Promień skrawka: 3 \\
    Wyniki: \\ 
    Czas: 18.08s  
    \vspace{0.5cm}
    \end{minipage}\\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Obr17/Obr17m.png_nlmeans_sc7_0.912172_initnone_ps13_10000_conf5_0.1_t585.154}.png}
    \vspace{0.5cm}
    \end{minipage}
	&
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Obr17/Obr17m.png_nlmeans_sc7_0.210501_initnone_ps3_10000_conf5_0.1_t18.0773}.png}
    \vspace{0.5cm}
    \end{minipage}\\ \hline

    \multicolumn{2}{|c|}{
    	Rozmycie tekstur w zależności od rozmiaru skrawka dla normy Poisson'a $(\lambda=.1)$
    } \\ \hline 
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma:  Poisson'a\\
    Promień skrawka: 3 \\
    Wyniki: \\ 
    Czas: 57.79s 
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    Parametry: \\
    Norma: Poisson'a\\
    Promień skrawka: 13 \\
    Wyniki: \\ 
    Czas: 984.07s  
    \vspace{0.5cm}
    \end{minipage}\\ \hline
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Obr4/Obr4m.png_nlpoisson_l0.1_sc7_0.107143_initnone_ps3_10000_conf5_0.1_t57.794}.png}
    \vspace{0.5cm}
    \end{minipage}
	&
    \begin{minipage}{0.5\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Obr4/Obr4m.png_nlpoisson_l0.1_sc7_0.464286_initnone_ps13_10000_conf5_0.1_t984.07}.png}
    \vspace{0.5cm}
    \end{minipage}\\ \hline
    
  \caption{Porównanie norm wmalowywania}\label{VFITESTS}
\end{longtable}

\begin{longtable}[h!]{|c|c|}
    \hline
    Obraz & Dane \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Osoba_druga/Osoba_drugam.png_nlpoisson_l0.1_sc7_0.139368_initnone_ps13_10000_conf5_0.1_t16316.7}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    Parametry: \\
    Norma: Poisson'a \\
    Promień skrawka: 13 \\
    Wyniki: \\ 
    Czas: 16316.70s  
    \end{minipage} \\ \hline
    
    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Osoba_druga/Osoba_drugam.png_nlmeans_sc7_0.139368_initnone_ps13_10000_conf5_0.1_t6857.42}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    Parametry: \\
    Norma: uśredniająca \\
    Promień skrawka: 13 \\
    Wyniki: \\ 
    Czas: 6857.42s  
    \end{minipage} \\ \hline

    \begin{minipage}{.65\textwidth}
    \vspace{0.5cm}
    \centering
    \includegraphics[height=3.8cm]{{TESTY/VFI/Osoba_druga/Osoba_drugam.png_nlmedians_sc7_0.0536029_initnone_ps5_10000_conf5_0.1_t1381.94}.png}
    \vspace{0.5cm}
    \end{minipage}
    &
    \begin{minipage}{.35\textwidth}
    Parametry: \\
    Norma: uśredniająca \\
    Promień skrawka: 5 \\
    Wyniki: \\ 
    Czas: 1381.94s
    \end{minipage} \\ \hline

	\caption{Nielokalny charakter algorytmu }
	\label{NONLOCALITYVFI}
\end{longtable}

Trzy zaprezentowane normy różnią się sposobem porównywania ze sobą skrawków. Wyniki uzyskane za pomocą norm $L^2$ stanowią gładką kontynuację obrazu wgłąb maski, natomiast oparte na $L^1$ faworyzują gwałtowne zmiany obrazu. Wyniki uzyskane dla normy bazującej na medianie \eqref{nonLocalMedians} charakteryzują się dokładniejszym odwzorowaniem tekstury - \kotmyszm,  nie gwarantując ostatecznie spójności obrazu w obszarze maski - \ObrIVm. Charakterem swoich wyników mogą przypominać metodę bazującą na metodzie Criminisi ze znacznie ograniczoną wadą niespójności w obrazie. Analizując wyniki \maciekIm \ i \ObrXVIIm, można zauważyć większą skuteczność odwzorowania struktur w przypadku większego rozmiaru skrawka, w szczególności dla normy \eqref{nonLocalMedians}. Zwiększający się  rozmiar skrawka w przypadku normy Poissona prowadzi do głębszego rozmycia odrestaurowywanego obszaru, a w przypadku normy uśredniającej do lepszego odrestaurowania struktury i tekstury - \ObrIVm. Parametr $\lambda$ wpływa na zdolność kontynuacji ostrych krawędzi obrazu. W przypadku zerowej wartości nadaje charakter wypełniania obrazu podobny do zastosowania mechaniki płynów w obrazie. Dla każdego z przypadków zwiększenie rozmiaru skrawka przyczynia się do wydłużenia czasu uzyskania ostatecznego wyniku. Najlepszymi właściwościami charakteryzuje się norma \eqref{nonLocalpoisson} stanowiąca połączenie normy $L^1$ z $L^2$. Wszystkie z opisanych norm gwarantują kontynuację powtarzających się głównych schematów obrazu - \autoref{NONLOCALITYVFI}. 
%-----------Koniec pracy magisterskiej-----------
\newpage
\bibliographystyle{unsrt}
\bibliography{bibliografia}

 
\tableofcontents
\clearpage
\pagestyle{empty}
\noindent Warszawa, dnia ...............
\vspace{5cm}
\begin{center}
\LARGE{Oświadczenie}
\end{center}
Oświadczam, że pracę magisterską pod tytułem: ,,Poprawa jakości obrazów cyfrowych poprzez metodę wmalowywania'', której promotorem jest dr Sławomir Skoneczny, wykonałem samodzielnie, co poświadczam własnoręcznym podpisem.
\vspace{2cm}
\begin{flushright}
...........................................
\end{flushright}

\end{document}

\begin{comment}

Do Naviera Stokesa po testach dodać informację o artykule, w którym jest dobrze przedstawiona dyfuzja anizotro
Brak nielokalnego podejścia do sprawy wmalowywania

Pomniejszanie obrazu w VFI ma sens bo stosowana jest minimalizacja po lokalizacji, nie ma sensu tego robić dla pozostałych metąd podążających do środka maski.

https://github.com/shangma/Fast-Anisotropic-Curvature-Preserving-Smoothing/blob/master/CalcImageStructureTensors.m

Dla NLCTV znaczna część czasu przeznaczona jest na pierwsze obliczenie wagi.

Pomysł na współczynnik. Segmentacja i sprawdzenie wariacji na piksel liczonej paczami 

Multiscale ma sens tylko przy metodach wykorzystujących minimalizację lokalizacji(np. patchmatch)

Norma faworyzuje ostrzejsze przekształcenia L^1 

Bardzo ograniczone zasoby pamięciowe przy NLCTV

W porównaniu NLCTV i VFI nie ma aż takiego znacznia dobór rozmiaru patcha.

Odnośnie VFI:
Na maćku widać, że większy patch przy nlmeans pozwala na połąćzenie wysepki
\end{comment}